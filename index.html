<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" sizes="24x24" href="https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/cbmlogo.png">
    <title>Enhanced Single Plane Balancing Calculator</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-group { margin-bottom: 1rem; }
        .input-group label, .radio-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #D1D5DB; background-color: #F9FAFB; }
        
        /* Dark mode inputs */
        .dark .input-group input, .dark .input-group select { background-color: #374151; border-color: #4B5563; color: #F3F4F6; }
        .dark .input-group input::placeholder, .dark .input-group select::placeholder { color: #9CA3AF; }

        .table-input { width: 100%; padding: 0.4rem; border-radius: 0.25rem; border: 1px solid #D1D5DB; font-size: 0.875rem; background-color: #F9FAFB; }
        .table-input:focus { border-color: #3B82F6; ring: 1px; ring-color: #3B82F6; }
        .dark .table-input { background-color: #374151; border-color: #4B5563; color: #F3F4F6; }
        
        .table-output { font-family: 'Inter', sans-serif; font-size: 0.875rem; color: #1E40AF; }
        .dark .table-output { color: #93C5FD; }

        #polarPlotContainer { position: relative; width: 100%; max-width: 600px; margin: 0 auto; }
        #rotationDirectionArrow { position: absolute; top: 10px; left: 10px; font-size: 0.9rem; font-weight: bold; color: #3B82F6; background-color: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px; z-index: 10; pointer-events: none; }
        .dark #rotationDirectionArrow { background-color: rgba(31, 41, 55, 0.8); color: #60A5FA; }

        /* Tooltip Styles */
        #polarPlotTooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 20;
            display: none;
            white-space: nowrap;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .legend-value {
            font-family: 'Courier New', monospace; 
            font-weight: 700;
            margin-left: 5px;
        }

        #polarPlotCanvas { border: 1px solid #93c5fd; border-radius: 0.375rem; width: 100%; height: auto; display: block; cursor: crosshair; }
        .dark #polarPlotCanvas { border-color: #2563EB; }
        
        .legend-color-box { display: inline-block; width: 12px; height: 12px; margin-right: 6px; vertical-align: middle; border-radius: 2px; }
        .legend-dot { display: inline-block; width: 10px; height: 10px; margin-right: 6px; vertical-align: middle; border-radius: 50%; }
        
        .tab-button { padding: 0.5rem 1rem; margin-right: 0.5rem; margin-bottom: -1px; border-radius: 0.375rem 0.375rem 0 0; border: 1px solid #D1D5DB; border-bottom: none; background-color: #E5E7EB; cursor: pointer; font-weight: 500; }
        .dark .tab-button { border-color: #374151; background-color: #374151; color: #D1D5DB; }
        
        .tab-button.active { background-color: white; border-bottom: 1px solid white; color: #3B82F6; }
        .dark .tab-button.active { background-color: #1F2937; border-bottom-color: #1F2937; color: #60A5FA; }
        
        .tab-content { border: 1px solid #D1D5DB; padding: 1.5rem; border-radius: 0 0.375rem 0.375rem 0.375rem; background-color: white; }
        .dark .tab-content { border-color: #374151; background-color: #1F2937; }
        
        .hidden { display: none; }
        .footer-button { padding: 0.6rem 1.2rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s ease-in-out; }
        
        .details-section { margin-bottom: 2rem; padding: 1.5rem; background-color: #f0f9ff; border-radius: 0.5rem; border: 1px solid #e0f2fe; }
        .dark .details-section { background-color: #0c4a6e; border-color: #075985; }
        
        .suggestion-section { margin-bottom: 2rem; padding: 1.5rem; background-color: #f0f5ff; border-radius: 0.5rem; border: 1px solid #e0e7ff; }
        .dark .suggestion-section { background-color: #3730a3; border-color: #312e81; }
        
        #rotorTypeImage { border: 1px solid #e5e7eb; border-radius: 0.25rem; }
        
        .prose { max-width: none; color: #374151; }
        .prose h4 { font-size: 1.125rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .prose h5 { font-size: 1rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; }
        .prose p { margin-top: 0.75rem; margin-bottom: 0.75rem; line-height: 1.6; }
        .prose ul, .prose ol { margin-top: 0.75rem; margin-bottom: 0.75rem; padding-left: 1.5rem; }
        .prose li { margin-top: 0.25rem; margin-bottom: 0.25rem; }
        .prose strong { font-weight: 600; }
        .dark .prose { color: #D1D5DB; }
        .dark .prose h4, .dark .prose h5 { color: #F9FAFB; }
        .dark .prose strong { color: #FFFFFF; }

        /* Result Cards */
        .result-card {
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .dark .result-card {
            background-color: rgba(0, 0, 0, 0.2);
            border-color: rgba(255,255,255,0.05);
        }

        /* Auth Overlay */
        #authOverlay {
            backdrop-filter: blur(5px);
        }
    </style>

    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-300 p-4 md:p-8 min-h-screen">

    <div id="authOverlay" class="fixed inset-0 z-[100] bg-gray-900/80 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <div class="text-center mb-6">
                <img src="https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/cbmlogo.png" alt="Logo" class="h-12 mx-auto mb-4">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Welcome Back</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Single Plane Balancing Calculator</p>
            </div>

            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="authEmail" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="you@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                        <input type="password" id="authPassword" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="••••••••">
                    </div>
                    <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition duration-200">
                        Sign In
                    </button>
                </div>
                <p class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
                    Don't have an account? 
                    <a href="#" id="toggleToSignup" class="text-blue-600 hover:text-blue-500 font-medium">Sign up</a>
                </p>
            </div>

            <div id="signupForm" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                        <input type="email" id="regEmail" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="you@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Create Password</label>
                        <input type="password" id="regPassword" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="••••••••">
                    </div>
                    <button id="btnSignup" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded-lg transition duration-200">
                        Create Account
                    </button>
                </div>
                <p class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
                    Already have an account? 
                    <a href="#" id="toggleToLogin" class="text-green-600 hover:text-green-500 font-medium">Sign in</a>
                </p>
            </div>
            <p id="authMessage" class="mt-4 text-center text-sm font-medium text-red-500 hidden"></p>
        </div>
    </div>

    <div id="mainAppContainer" class="container mx-auto max-w-6xl bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl dark:shadow-gray-900/50 opacity-20 pointer-events-none transition-opacity duration-300">
        
        <div class="flex justify-end mb-2 text-sm text-gray-600 dark:text-gray-400 items-center gap-4">
            <span id="currentUserDisplay"><i class="fas fa-user-circle"></i> Not Logged In</span>
            <button id="btnLogout" class="text-red-500 hover:text-red-700 font-medium"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <button id="darkModeToggle" class="fixed top-4 right-4 z-50 p-2 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-lg transition-colors">
            <svg id="sunIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>

        <header class="mb-8 flex justify-between items-center flex-wrap">
            <img src="https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/cbmlogo.png" alt="Left Logo" class="h-8 md:h-10" onerror="this.onerror=null; this.src='https://placehold.co/120x40/cccccc/333333?text=Logo+Error';">
            
            <div class="text-center flex-grow">
                <h1 class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2">Enhanced Single Plane Balancing</h1>
                <p class="text-sm md:text-base text-gray-600 dark:text-gray-400">Vector Method Calculator</p>
            </div>

            <img src="https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/cbmlogo.png" alt="Right Logo" class="h-8 md:h-10" onerror="this.onerror=null; this.src='https://placehold.co/120x40/cccccc/333333?text=Logo+Error';">

            <div class="w-full grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                <div class="input-group relative">
                    <label for="equipmentName" class="font-medium text-gray-700 dark:text-gray-300"><i class="fas fa-fan"></i> Equipment Name:</label>
                    <div class="flex gap-2">
                        <input type="text" id="equipmentName" placeholder="e.g., Cooling Tower Fan" class="mt-1 focus:ring-blue-500 focus:border-blue-500">
                        <button id="searchCloudButton" class="mt-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 rounded" title="Search History">
                            <i class="fas fa-cloud-download-alt"></i>
                        </button>
                    </div>
                </div>

                <div id="cloudResultsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 dark:text-white">My Balancing History</h3>
                        <div id="cloudResultsList" class="space-y-2"></div>
                        <button onclick="document.getElementById('cloudResultsModal').classList.add('hidden')" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Close</button>
                    </div>
                </div>

                <div class="input-group">
                    <label for="plantName" class="font-medium text-gray-700 dark:text-gray-300"><i class="fas fa-industry"></i> Plant:</label>
                    <input type="text" id="plantName" placeholder="e.g., Steel Melting Shop" class="mt-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="input-group">
                    <label for="reportDate" class="font-medium text-gray-700 dark:text-gray-300"><i class="far fa-calendar-alt"></i> Date:</label>
                    <input type="date" id="reportDate" class="mt-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </header>

        <div class="details-section">
            <h2 class="text-xl font-semibold mb-4 text-sky-700 dark:text-sky-200"><i class="fas fa-cogs mr-2"></i> Equipment Details</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-4">
                <div class="input-group">
                    <label for="numVanes" class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-certificate"></i> Number of Vanes:</label>
                    <input type="number" id="numVanes" value="12" class="mt-1 focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-sync-alt mr-2"></i> Direction of Rotation:</label>
                    <div class="mt-2 flex items-center space-x-2">
                        <button id="rotDirCCW" class="px-3 py-1.5 text-sm font-medium rounded-md bg-sky-600 text-white">CCW</button>
                        <button id="rotDirCW" class="px-3 py-1.5 text-sm font-medium rounded-md bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500">CW</button>
                        <input type="hidden" id="rotationDirection" value="CCW">
                    </div>
                </div>
                <div class="input-group">
                    <label for="ratedPower" class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-bolt"></i> Rated Power (kW/HP):</label>
                    <input type="text" id="ratedPower" placeholder="e.g., 50 kW" class="mt-1 focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div class="input-group">
                    <label for="rotorRPM" class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-tachometer-alt"></i> Rotor RPM:</label>
                    <input type="number" id="rotorRPM" step="any" placeholder="e.g., 3000" class="mt-1 focus:ring-sky-500 focus:border-sky-500">
                </div>
                 <div class="input-group md:col-span-2">
                    <label for="measurementLocation" class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-map-marker-alt"></i> Location for Plot & Splitting:</label>
                    <select id="measurementLocation" class="mt-1 focus:ring-sky-500 focus:border-sky-500">
                        <option value="IBH">Inboard Horizontal (IBH)</option>
                        <option value="IBV">Inboard Vertical (IBV)</option>
                        <option value="IBA">Inboard Axial (IBA)</option>
                        <option value="OBH">Outboard Horizontal (OBH)</option>
                        <option value="OBV">Outboard Vertical (OBV)</option>
                        <option value="OBA">Outboard Axial (OBA)</option>
                    </select>
                </div>
                 <div class="input-group md:col-span-2"> 
                    <label for="rotorTypeSelect" class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-shapes"></i> Rotor Type:</label>
                    <div class="mt-1 flex flex-col items-center"> <select id="rotorTypeSelect" class="w-full md:w-auto md:min-w-[180px] focus:ring-sky-500 focus:border-sky-500">
                            <option value="">Select Type</option>
                            <option value="Overhung">Overhung</option>
                            <option value="Centerhung">Centerhung</option>
                        </select>
                        <img id="rotorTypeImage" src="" alt="Rotor Type Image" class="hidden mt-2 h-20 md:h-24 w-auto object-contain"> 
                    </div>
                </div>
                  <div class="input-group">
                    <label for="assetId" class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-fingerprint"></i> Asset ID:</label>
                    <input type="text" id="assetId" placeholder="e.g., A-1234" class="mt-1 focus:ring-sky-500 focus:border-sky-500">
                </div>
                    <div class="input-group">
                    <label for="previousWeight" class="font-medium text-sky-700 dark:text-sky-300"><i class="fas fa-history"></i> No's of Weights Available:</label>
                    <input type="text" id="previousWeight" placeholder="e.g., 3" class="mt-1 focus:ring-sky-500 focus:border-sky-500">
                </div>
            </div>
        </div>
        
        <div class="mb-4 mt-4">
            <label for="analystRemarks" class="block font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="fas fa-edit"></i> Analyst Observations / Remarks:
            </label>
            <textarea id="analystRemarks" rows="3" 
                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter your observations, root cause findings, or recommendations here..."></textarea>
        </div>

        <div class="mb-4">
            <button id="toggleTrialWeightSectionButton" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 mb-2">
                Hide Trial Weight Calculator
            </button>
            <div id="trialWeightSuggestionContainer" class="suggestion-section">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700 dark:text-indigo-200"><i class="fas fa-calculator mr-2"></i> Trial Weight Suggestion</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="rotorWeight" class="text-gray-700 dark:text-gray-300">Rotor Weight (kg):</label>
                        <input type="number" id="rotorWeight" step="any" placeholder="e.g., 100" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="trialRadius" class="text-gray-700 dark:text-gray-300">Trial Weight Radius (mm):</label>
                        <input type="number" id="trialRadius" step="any" placeholder="e.g., 250" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <button id="suggestTrialWeightButton" class="mt-4 w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    Suggest Trial Weight
                </button>
                <p id="suggestedTrialWeightResult" class="mt-3 text-indigo-800 dark:text-indigo-200 font-medium"></p>
            </div>
        </div>

        <div class="mb-4 flex flex-wrap border-b border-gray-300 dark:border-gray-700">
            <button id="tabStandard" class="tab-button active"><i class="fas fa-balance-scale-left mr-2"></i> Standard (Trial Run)</button>
            <button id="tabKnownIC" class="tab-button"><i class="fas fa-brain mr-2"></i> Known IC</button>
            <button id="tabTrim" class="tab-button"><i class="fas fa-cut mr-2"></i> Trim</button>
            <button id="tabSplitting" class="tab-button"><i class="fas fa-project-diagram mr-2"></i> Splitting</button>
            <button id="tabAbout" class="tab-button"><i class="fas fa-info-circle mr-2"></i> About</button>
        </div>

        <div id="main-content-stack" class="flex flex-col gap-8">
            <div>
                <div id="contentStandard" class="tab-content">
                    <h2 class="text-xl font-semibold mb-4 text-blue-700 dark:text-blue-300">Standard Balancing Inputs</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Check one or more locations to include in calculation.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="px-2 py-2 text-center font-medium text-gray-500 dark:text-gray-400 tracking-wider">
                                        <input type="checkbox" id="selectAllStandard" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" title="Select All">
                                    </th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Location</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">O Amp</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">O Phase</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">O+T Amp</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">O+T Phase</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">IC Mag</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">IC Angle</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Final Amp</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Final Phase</th>
                                </tr>
                            </thead>
                            <tbody id="standardBalancingTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                        </table>
                    </div>

                    <h3 class="text-lg font-medium mt-6 mb-2 text-gray-700 dark:text-gray-300"><i class="fas fa-weight-hanging mr-2"></i> Trial Weight (Wt) - (Global)</h3>
                    <div class="flex items-center mt-1 mb-2">
                        <input type="checkbox" id="trialWeightRemovedCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="trialWeightRemovedCheckbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-200 font-medium">Is initially weight was removed(Yes/No)</label>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-gray-700 dark:text-gray-300">Mass (grams):</label>
                            <input type="number" id="trialWeightMass" step="any" placeholder="e.g., 10.0" class="focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="input-group">
                            <label class="text-gray-700 dark:text-gray-300">Angle (&deg; CCW from Ref):</label>
                            <input type="number" id="trialWeightAngle" step="any" placeholder="e.g., 0" class="focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <h3 class="text-lg font-medium mt-6 mb-2 text-gray-700 dark:text-gray-300">Correction Strategy</h3>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="strategyRemove" name="correctionStrategy" type="radio" value="remove" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="strategyRemove" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Remove trial weight (Calculate total Wc)
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input id="strategyKeep" name="correctionStrategy" type="radio" value="keep" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="strategyKeep" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Keep trial weight (Calculate additional Wc)
                            </label>
                        </div>
                    </div>

                    <button id="calculateStandardButton" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Calculate Balancing Parameters
                    </button>
                </div>

                <div id="contentKnownIC" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4 text-purple-700 dark:text-purple-300">Correction with Known IC</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Check one or more locations to include in calculation.</p>
                    <div class="overflow-x-auto">
                      <div class="flex justify-end mb-2">
    <button id="btnClearReadingsKnownIC" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-1 px-3 rounded transition">
        <i class="fas fa-eraser mr-1"></i> Clear Readings (Keep ICs)
    </button>
</div>
                        <table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="px-2 py-2 text-center font-medium text-gray-500 dark:text-gray-400 tracking-wider">
                                        <input type="checkbox" id="selectAllKnownIC" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500" title="Select All">
                                    </th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Location</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">O Amp</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">O Phase</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Known IC Mag</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Known IC Angle</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Final Amp</th>
                                    <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Final Phase</th>
                                </tr>
                            </thead>
                            <tbody id="knownIcTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                        </table>
                    </div>

                    <button id="calculateKnownICButton" class="mt-6 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                        Calculate Correction Weight
                    </button>
                </div>

                <div id="contentTrim" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700 dark:text-indigo-300">Multi-Point Trim Balancing</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Enter the residual vibration (current levels) and the Influence Coefficients. Check multiple boxes to calculate a "Best Fit" (Least Squares) trim weight.
                    </p>

                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-indigo-50 dark:bg-indigo-900/50">
    <tr>
        <th class="px-2 py-2 text-center font-medium text-gray-500 dark:text-gray-400 tracking-wider">
            <input type="checkbox" id="selectAllTrim" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" title="Select All">
        </th>
        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Location</th>
        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Residual Amp</th>
        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Residual Phase</th>
        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">IC Mag</th>
        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">IC Angle</th>
        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider border-l border-indigo-200 dark:border-indigo-700 pl-3">Post-Trim Amp</th>
        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-400 tracking-wider">Post-Trim Phase</th>
    </tr>
</thead>
                            <tbody id="trimBalancingTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                        </table>
                    </div>

                    <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-700/30 rounded border border-gray-200 dark:border-gray-600">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="trimMergeCheckbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="trimMergeCheckbox" class="ml-2 font-medium text-gray-700 dark:text-gray-300">
                                Merge with Previous Weight?
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Check this if you want to vector-add the Trim Weight to a weight already on the rotor.</p>
                        
                        <div id="trimPreviousWeightInputs" class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div class="input-group">
                                <label>Existing Weight Mass:</label>
                                <input type="number" id="trimPrevMass" step="any" class="mt-1" placeholder="Existing on rotor">
                            </div>
                            <div class="input-group">
                                <label>Existing Weight Angle:</label>
                                <input type="number" id="trimPrevAngle" step="any" class="mt-1" placeholder="Existing on rotor">
                            </div>
                        </div>
                    </div>

                    <button id="calculateTrimButton" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                        Calculate Multi-Point Trim Weight
                    </button>

                    <div id="trimResults" class="mt-6 hidden p-4 bg-indigo-50 dark:bg-indigo-900/40 border border-indigo-200 dark:border-indigo-800 rounded-lg">
                        <h3 class="text-lg font-bold text-indigo-800 dark:text-indigo-200 mb-2">Trim Result (Least Squares)</h3>
                        
                        <div id="trimSoloResult">
                            <p class="text-sm text-gray-700 dark:text-gray-300">Add this separate trim weight:</p>
                            <p class="ml-4 text-lg font-mono text-indigo-700 dark:text-indigo-300">
                                <span id="trimMassResult">---</span> g @ <span id="trimAngleResult">---</span>&deg;
                            </p>
                        </div>

                        <div id="trimMergedResult" class="hidden mt-2 pt-2 border-t border-indigo-200 dark:border-indigo-700">
                            <p class="text-sm font-bold text-gray-700 dark:text-gray-300">New Total Weight (Replace Old):</p>
                            <p class="ml-4 text-lg font-mono text-indigo-700 dark:text-indigo-300">
                                <span id="trimTotalMassResult">---</span> g @ <span id="trimTotalAngleResult">---</span>&deg;
                            </p>
                        </div>
                    </div>
                </div>

                <div id="contentSplitting" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4 text-teal-700 dark:text-teal-300">Splitting Correction Weight</h2>
                     <p class="mb-3 text-sm text-gray-600 dark:text-gray-400">Using Wc from: <strong id="currentLocSplitting">IBH</strong></p>
                    <h3 class="text-lg font-medium mt-4 mb-2 text-gray-700 dark:text-gray-300">Original Correction Weight (Wc)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-gray-700 dark:text-gray-300">Mass (gram):</label>
                            <input type="number" id="splitWcMassInput" step="any" placeholder="From calc" class="focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div class="input-group">
                            <label class="text-gray-700 dark:text-gray-300">Angle (&deg; CCW):</label>
                            <input type="number" id="splitWcAngleInput" step="any" placeholder="From calc" class="focus:ring-teal-500 focus:border-teal-500">
                        </div>
                    </div>
                     <h3 class="text-lg font-medium mt-4 mb-2 text-gray-700 dark:text-gray-300">Splitting Parameters</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-gray-700 dark:text-gray-300">Number of Available Locations:</label>
                            <input type="number" id="splitNumHolesInput" step="1" placeholder="e.g., 12" class="focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div class="input-group">
                            <label class="text-gray-700 dark:text-gray-300">Angle of First Location (&deg; CCW):</label>
                            <input type="number" id="splitFirstHoleAngleInput" step="any" value="0" placeholder="e.g., 0" class="focus:ring-teal-500 focus:border-teal-500">
                        </div>
                    </div>
                    <button id="calculateSplitWeightsButton" class="mt-6 w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">
                        Calculate Split Weights
                    </button>
                    <div id="splitResultsDisplay" class="results-group mt-4 hidden dark:text-gray-200">
                        <p><strong>Split Weight 1 (W1):</strong></p>
                        <p class="ml-4">Mass: <span id="splitWeight1Mass" class="font-mono">---</span></p>
                        <p class="ml-4">Placement Angle: <span id="splitWeight1Angle" class="font-mono">---</span> &deg;</p>
                        <p class="mt-2"><strong>Split Weight 2 (W2):</strong></p>
                        <p class="ml-4">Mass: <span id="splitWeight2Mass" class="font-mono">---</span></p>
                        <p class="ml-4">Placement Angle: <span id="splitWeight2Angle" class="font-mono">---</span> &deg;</p>
                    </div>
                     <p id="splitErrorMessage" class="mt-3 text-red-600 dark:text-red-400 font-medium hidden"></p>
                </div>

                <div id="contentAbout" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">About This Calculator</h2>
                    <div class="prose"> <p>This Enhanced Single Plane Balancing Calculator (Vector Method) is designed to assist maintenance professionals and engineers in performing single-plane balancing of rotating machinery.</p>
                        <p>Key features include:</p>
                        <ul>
                            <li>**New:** Cloud Storage with secure Login.</li>
                            <li>**New:** Table-based data entry for all 6 locations.</li>
                            <li>**New:** Automatic calculation logic (Least Squares).</li>
                            <li>Standard trial weight method and Known IC method.</li>
                            <li>Trim Balancing with multi-point support.</li>
                            <li>Interactive polar plot visualization.</li>
                        </ul>
                        <p><strong>Disclaimer:</strong> This calculator provides theoretical calculations based on the inputs provided. Always follow established safety procedures.</p>
                        <p class="text-sm mt-4">Version: 13.0 (Cloud Auth Enabled)</p>
                    </div>
                </div>
            </div>

            <div id="resultsDisplay" class="p-6 bg-green-50 dark:bg-green-900/50 rounded-lg border border-green-200 dark:border-green-800 hidden">
                <h2 id="resultsTitle" class="text-xl font-semibold mb-4 text-green-700 dark:text-green-300 text-center">
                    Calculated Results (for <span id="resultLocation" class="font-bold"></span>)
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 dark:text-gray-200">
                    
                    <div id="icResults" class="result-card">
                        <p class="font-semibold mb-2 text-green-800 dark:text-green-200">Influence Coefficient (IC) <span id="icLocationLabel" class="text-xs font-normal"></span></p>
                        <div class="flex flex-col space-y-1">
                            <div class="flex justify-between"><span>Mag:</span> <span id="icMagnitude" class="font-mono font-bold">---</span> <span class="text-xs font-normal">mm/s/g</span></div>
                            <div class="flex justify-between"><span>Angle:</span> <span id="icAngle" class="font-mono font-bold">---</span>&deg;</div>
                        </div>
                    </div>

                    <div id="correctionWeightResults" class="result-card border-green-300 dark:border-green-600 bg-green-100/50 dark:bg-green-800/30">
                        <p class="font-semibold mb-2 text-green-800 dark:text-green-200" id="correctionWeightLabel">Correction Weight (Wc)</p>
                        <div class="flex flex-col space-y-1">
                            <div class="flex justify-between"><span>Mass:</span> <span id="correctionWeightMass" class="font-mono font-bold text-lg">---</span> <span class="text-xs font-normal">g</span></div>
                            <div class="flex justify-between"><span>Angle:</span> <span id="correctionWeightAngle" class="font-mono font-bold text-lg">---</span>&deg;</div>
                        </div>
                    </div>

                    <div id="correctionWeightRemovalResults" class="result-card hidden">
                        <p class="font-semibold mb-2 text-green-800 dark:text-green-200" id="removalWeightLabel">Remove Weight</p>
                         <div class="flex flex-col space-y-1">
                            <div class="flex justify-between"><span>Mass:</span> <span id="removalWeightMass" class="font-mono font-bold">---</span> <span class="text-xs font-normal">g</span></div>
                            <div class="flex justify-between"><span>Angle:</span> <span id="removalWeightAngle" class="font-mono font-bold">---</span>&deg;</div>
                        </div>
                    </div>

                </div>

                <div class="results-group mt-4 pt-4 border-t border-green-200 dark:border-green-700">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 text-center">Log Final Action Taken:</label>
                    <div class="flex justify-center space-x-8">
                        <div class="flex items-center">
                            <input id="finalActionAdd" name="finalAction" type="radio" value="add" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="finalActionAdd" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Weight Added
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input id="finalActionRemove" name="finalAction" type="radio" value="remove" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="finalActionRemove" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Weight Removed
                            </label>
                        </div>
                    </div>
                </div>

                <div id="predictedResidualsDisplay" class="results-group mt-4 hidden dark:text-gray-200 text-center bg-white/40 dark:bg-black/20 p-2 rounded">
                     <p class="text-sm"><strong>Predicted Residuals (mm/s):</strong> <span id="predictedResidualsList" class="font-mono ml-2"></span></p>
                </div>
            </div>
            
            <div id="errorMessage" class="p-4 bg-red-50 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg border border-red-200 dark:border-red-800 hidden">
                Error: <span id="errorText"></span>
            </div>

            <div id="polar-plot-column" class="flex flex-col items-center w-full">
                <h2 class="text-xl font-semibold mb-2 text-blue-700 dark:text-blue-300"><i class="fas fa-bullseye"></i> Polar Plot (<span id="plotLocationLabel">IBH</span>)</h2>
                <div id="polarPlotContainer"> 
                    <div id="rotationDirectionArrow" class="text-center dark:text-blue-400">CCW ↺</div>
                    <div id="polarPlotTooltip"></div>
                    <canvas id="polarPlotCanvas"></canvas>
                </div>
                <div id="plotLegend" class="mt-4 text-sm space-y-1 font-medium grid grid-cols-2 md:grid-cols-2 gap-x-4 gap-y-2 w-full max-w-xl">
                    </div>
            </div>
        </div>
        <footer class="mt-12 pt-8 border-t border-gray-300 dark:border-gray-700 text-center">
            <div class="flex flex-wrap justify-center gap-3 md:gap-4 mb-4">
                <button id="printReportButton" class="footer-button bg-teal-500 hover:bg-teal-600 text-white">
                    <i class="fas fa-print"></i> Print Report
                </button>
                <button id="exportWordButton" class="footer-button bg-blue-500 hover:bg-blue-600 text-white">
                    <i class="fas fa-file-word"></i> Export for Word
                </button>
                <button id="saveToCloudButton" class="footer-button bg-indigo-500 hover:bg-indigo-600 text-white">
                    <i class="fas fa-cloud-upload-alt"></i> Save to Cloud
                </button>
                <button id="saveDataButton" class="footer-button bg-sky-500 hover:bg-sky-600 text-white">
                    <i class="fas fa-download"></i> Save Data
                </button>
                <button id="loadDataButton" class="footer-button bg-amber-500 hover:bg-amber-600 text-white">
                    <i class="fas fa-upload"></i> Load Data
                </button>
                <button id="resetFormButton" class="footer-button bg-red-500 hover:bg-red-600 text-white">
                    <i class="fas fa-trash-alt"></i> Reset All
                </button>
            </div>
            <p class="text-gray-700 dark:text-gray-400 text-sm">Copyright © 2025 Condition Monitoring. All Rights Reserved.</p>
            <p class="text-gray-700 dark:text-gray-400 text-sm">Developed by Sourav Biswal</p>
        </footer>
    </div>

    <script>
      // --- SUPABASE SAVE & SEARCH (FIXED) ---
    document.getElementById('saveToCloudButton').addEventListener('click', async () => {
        const eqName = equipmentNameInput.value;
        const plName = plantNameInput.value;
        const rDate = reportDateInput.value;

        if(!eqName) { alert("Please enter an Equipment Name first."); return; }

        const allData = {
            header: { equipmentName: eqName, plantName: plName, reportDate: rDate },
            details: {
                numVanes: numVanesInput.value,
                rotationDirection: rotationDirectionInput.value,
                ratedPower: ratedPowerInput.value,
                rotorRPM: rotorRPMInput.value,
                rotorType: rotorTypeSelect.value,
                // --- NEW FIELDS ---
                assetId: getInputValue('assetId', ''),
                previousWeight: getInputValue('previousWeight', '')
            },
            // ADD THIS NEW FIELD AT THE ROOT LEVEL (or inside details if you prefer)
            remarks: getInputValue('analystRemarks', ''),
            suggestion: { rotorWeight: rotorWeightInput.value, trialRadius: trialRadiusInput.value },
            globalState: {
                lastCalculationMode: lastCalculationMode,
                lastProcessedLocations: lastProcessedLocations,
                lastBalancingAction: lastBalancingAction,
                measurementLocation: measurementLocationSelect.value
            },
            balancingData: balancingData
        };

        const { data, error } = await supabase
            .from('balancing_records')
            .insert([
                { 
                    equipment_name: eqName, 
                    plant_name: plName, 
                    report_date: rDate, 
                    full_data: allData 
                }
            ]);

        if (error) {
            alert('Error saving to cloud: ' + error.message);
        } else {
            alert('Successfully saved to Supabase Cloud!');
        }
    });

    document.getElementById('searchCloudButton').addEventListener('click', async () => {
        const eqName = equipmentNameInput.value;
        const plName = plantNameInput.value;
        
        let query = supabase.from('balancing_records').select('id, report_date, equipment_name, plant_name, full_data').order('report_date', { ascending: false });

        if (eqName) { query = query.ilike('equipment_name', `%${eqName}%`); }
        if (plName) { query = query.ilike('plant_name', `%${plName}%`); }

        const { data, error } = await query;

        if (error) {
            alert("Error fetching history: " + error.message);
            return;
        }

        if (data.length === 0) {
            alert("No records found.");
            return;
        }

        const listContainer = document.getElementById('cloudResultsList');
        listContainer.innerHTML = '';
        
        data.forEach(record => {
            const div = document.createElement('div');
            div.className = "p-3 border border-gray-300 dark:border-gray-600 rounded hover:bg-blue-50 dark:hover:bg-gray-700 cursor-pointer flex justify-between items-center transition";
            div.innerHTML = `
                <div>
                    <p class="font-bold dark:text-gray-200">${record.equipment_name}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${record.plant_name || 'No Plant'} | ${record.report_date}</p>
                </div>
                <span class="text-blue-600 dark:text-blue-400 text-sm font-medium">Load</span>
            `;
            div.onclick = () => {
                loadDataFromObject(record.full_data); 
                document.getElementById('cloudResultsModal').classList.add('hidden'); 
            };
            listContainer.appendChild(div);
        });

        document.getElementById('cloudResultsModal').classList.remove('hidden');
    });
    // Listener for the new "Clear Readings Only" button
document.getElementById('btnClearReadingsKnownIC').addEventListener('click', () => {
    // 1. Confirm intent so user doesn't accidentally wipe data
    if (!confirm("Are you sure? This will clear Original & Final vibration data but KEEP the Influence Coefficients.")) {
        return;
    }

    // 2. Loop through all locations and clear ONLY the run data
    locations.forEach(loc => {
        // Clear Original Run
        balancingData[loc].originalAmp = null;
        balancingData[loc].originalAngle = null;
        
        // Clear Final/Residual Run
        balancingData[loc].finalAmp = null;
        balancingData[loc].finalAngle = null;

        // Also clear Trial Run data (since we are using Known IC, this is irrelevant/confusing to keep)
        balancingData[loc].trialRunAmp = null;
        balancingData[loc].trialRunAngle = null;
        
        // Clear any previous calculated correction results
        balancingData[loc].correctionMass = null;
        balancingData[loc].correctionAngle = null;
        balancingData[loc].removalMass = null;
        balancingData[loc].removalAngle = null;

        // NOTE: We specifically DO NOT touch knownICMag, knownICAngle, calculatedICMag, or calculatedICAngle
    });

    // 3. Refresh the UI
    populateInputTables(); // This re-renders the inputs with empty strings for Amps/Angles but keeps ICs
    
    // 4. Hide old results
    document.getElementById('resultsDisplay').classList.add('hidden');
    
    // 5. Update the plot (it will likely go blank or show nothing until new data is entered)
    drawPolarPlotBasedOnMode();
});
        // --- Global Variables & DOM Elements ---
        const locations = ["IBH", "IBV", "IBA", "OBH", "OBV", "OBA"];
        let balancingData = {}; 
        let splitWeightResults = { w1: null, w2: null }; 
        let lastCalculationMode = 'N/A'; 
        let lastProcessedLocations = []; 
        let lastBalancingAction = 'add'; 
        let vectorHitBoxes = []; 
        let currentUser = null; // For Auth state

        // *** Dark Mode Elements ***
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');

        // ... (Supabase) ...
        const supabaseUrl = 'https://lgyladuiyezqccyjxqgn.supabase.co'; // <--- YOUR URL
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxneWxhZHVpeWV6cWNjeWp4cWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDEyMTksImV4cCI6MjA3ODUxNzIxOX0.O-K3aJkcdvnj0k3ltu37AK3hrW2ibZCZbwVy9SDTBZg'; // <--- YOUR KEY
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // ... (Existing DOM Elements) ...
        const authOverlay = document.getElementById('authOverlay');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const toggleToSignup = document.getElementById('toggleToSignup');
        const toggleToLogin = document.getElementById('toggleToLogin');
        const authMessage = document.getElementById('authMessage');
        const btnLogin = document.getElementById('btnLogin');
        const btnSignup = document.getElementById('btnSignup');
        const btnLogout = document.getElementById('btnLogout');
        const currentUserDisplay = document.getElementById('currentUserDisplay');

        // Other Elements
        const rotorTypeImageSources = { "Overhung": "https://i.ibb.co/r2gmqVyX/download.png", "Centerhung": "https://i.ibb.co/Q7n6wPnp/download-1.png" };
        const polarPlotColumn = document.getElementById('polar-plot-column');
        const tabStandardButton = document.getElementById('tabStandard');
        const tabKnownICButton = document.getElementById('tabKnownIC');
        const tabTrimButton = document.getElementById('tabTrim'); 
        const tabSplittingButton = document.getElementById('tabSplitting');
        const tabAboutButton = document.getElementById('tabAbout');
        const contentStandardDiv = document.getElementById('contentStandard');
        const contentKnownICDiv = document.getElementById('contentKnownIC');
        const contentTrimDiv = document.getElementById('contentTrim'); 
        const contentSplittingDiv = document.getElementById('contentSplitting');
        const contentAboutDiv = document.getElementById('contentAbout');
        const numVanesInput = document.getElementById('numVanes');
        const rotDirCCWButton = document.getElementById('rotDirCCW');
        const rotDirCWButton = document.getElementById('rotDirCW');
        const rotationDirectionInput = document.getElementById('rotationDirection');
        const measurementLocationSelect = document.getElementById('measurementLocation');
        const rotationDirectionArrowDiv = document.getElementById('rotationDirectionArrow');
        const ratedPowerInput = document.getElementById('ratedPower'); 
        const rotorRPMInput = document.getElementById('rotorRPM'); 
        const rotorTypeSelect = document.getElementById('rotorTypeSelect');
        const rotorTypeImage = document.getElementById('rotorTypeImage');
        const currentLocSplittingSpan = document.getElementById('currentLocSplitting');
        const plotLocationLabelSpan = document.getElementById('plotLocationLabel');
        const standardBalancingTableBody = document.getElementById('standardBalancingTableBody');
        const knownIcTableBody = document.getElementById('knownIcTableBody');
        const trimBalancingTableBody = document.getElementById('trimBalancingTableBody'); 
        const trialWeightMassInput = document.getElementById('trialWeightMass');
        const trialWeightAngleInput = document.getElementById('trialWeightAngle');
        const calculateStandardButton = document.getElementById('calculateStandardButton');
        const calculateKnownICButton = document.getElementById('calculateKnownICButton');
        const trimMergeCheckbox = document.getElementById('trimMergeCheckbox');
        const trimPreviousWeightInputs = document.getElementById('trimPreviousWeightInputs');
        const trimPrevMassInput = document.getElementById('trimPrevMass');
        const trimPrevAngleInput = document.getElementById('trimPrevAngle');
        const calculateTrimButton = document.getElementById('calculateTrimButton');
        const trimResultsDiv = document.getElementById('trimResults');
        const rotorWeightInput = document.getElementById('rotorWeight'); 
        const trialRadiusInput = document.getElementById('trialRadius'); 
        const suggestTrialWeightButton = document.getElementById('suggestTrialWeightButton');
        const suggestedTrialWeightResultP = document.getElementById('suggestedTrialWeightResult');
        const toggleTrialWeightSectionButton = document.getElementById('toggleTrialWeightSectionButton');
        const trialWeightSuggestionContainerDiv = document.getElementById('trialWeightSuggestionContainer');
        const resultsDisplayDiv = document.getElementById('resultsDisplay');
        const resultsTitle = document.getElementById('resultsTitle'); 
        const resultLocationSpan = document.getElementById('resultLocation');
        const icResultsDiv = document.getElementById('icResults');
        const icLocationLabelSpan = document.getElementById('icLocationLabel'); 
        const icMagnitudeSpan = document.getElementById('icMagnitude');
        const icAngleSpan = document.getElementById('icAngle');
        const correctionWeightLabel = document.getElementById('correctionWeightLabel');
        const correctionWeightMassSpan = document.getElementById('correctionWeightMass');
        const correctionWeightAngleSpan = document.getElementById('correctionWeightAngle');
        const predictedResidualsDisplayDiv = document.getElementById('predictedResidualsDisplay'); 
        const predictedResidualsListSpan = document.getElementById('predictedResidualsList'); 
        const errorMessageDiv = document.getElementById('errorMessage');
        const errorTextSpan = document.getElementById('errorText');
        const splitWcMassInput = document.getElementById('splitWcMassInput');
        const splitWcAngleInput = document.getElementById('splitWcAngleInput');
        const splitNumHolesInput = document.getElementById('splitNumHolesInput');
        const splitFirstHoleAngleInput = document.getElementById('splitFirstHoleAngleInput');
        const calculateSplitWeightsButton = document.getElementById('calculateSplitWeightsButton');
        const splitResultsDisplayDiv = document.getElementById('splitResultsDisplay');
        const splitWeight1MassSpan = document.getElementById('splitWeight1Mass');
        const splitWeight1AngleSpan = document.getElementById('splitWeight1Angle');
        const splitWeight2MassSpan = document.getElementById('splitWeight2Mass');
        const splitWeight2AngleSpan = document.getElementById('splitWeight2Angle');
        const splitErrorMessageP = document.getElementById('splitErrorMessage');
        const canvas = document.getElementById('polarPlotCanvas');
        const ctx = canvas.getContext('2d');
        const plotLegendDiv = document.getElementById('plotLegend');
        const equipmentNameInput = document.getElementById('equipmentName');
        const plantNameInput = document.getElementById('plantName');
        const reportDateInput = document.getElementById('reportDate');
        const printReportButton = document.getElementById('printReportButton');
        const exportWordButton = document.getElementById('exportWordButton'); 
        const saveDataButton = document.getElementById('saveDataButton');
        const loadDataButton = document.getElementById('loadDataButton');
        const resetFormButton = document.getElementById('resetFormButton');

        // --- AUTHENTICATION LOGIC ---
        
        // Toggle Forms
        toggleToSignup.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            authMessage.classList.add('hidden');
        });
        toggleToLogin.addEventListener('click', () => {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            authMessage.classList.add('hidden');
        });

        // Sign In
        btnLogin.addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            authMessage.classList.add('hidden');
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                authMessage.textContent = error.message;
                authMessage.classList.remove('hidden');
            } else {
                // Auth state listener will handle UI change
            }
        });

        // Sign Up
        btnSignup.addEventListener('click', async () => {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            authMessage.classList.add('hidden');

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (error) {
                authMessage.textContent = error.message;
                authMessage.classList.remove('hidden');
            } else {
                authMessage.textContent = "Registration successful! Please check your email to verify, or try logging in.";
                authMessage.classList.remove('text-red-500');
                authMessage.classList.add('text-green-500');
                authMessage.classList.remove('hidden');
            }
        });

        // Logout
        btnLogout.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) console.error('Error logging out:', error);
            window.location.reload();
        });

// 1. Define a LIST of admins
const ADMIN_EMAILS = [
    'souravbiswal50@gmail.com',
    'kandregula.vijaykrishna@tatasteel.com',
    'abinash.bhuyan@tatasteel.com',
    'hrishita.hiremath@tatasteel.com',
    'upali.behera@tatasteel.com',
    'rahul.pandit@tatasteel.com',
    'Rajesh.kar2@tatasteel.com',
    'abhishek.karn@tatasteel.com'
];

supabase.auth.onAuthStateChange((event, session) => {
    if (session) {
        currentUser = session.user;
        authOverlay.classList.add('hidden');
        mainAppContainer.classList.remove('opacity-20', 'pointer-events-none');
        currentUserDisplay.innerHTML = `<i class="fas fa-user-circle"></i> ${currentUser.email}`;

        // 2. Check if the current user is in the list
        const saveButton = document.getElementById('saveToCloudButton');
        
        if (ADMIN_EMAILS.includes(currentUser.email)) {
            saveButton.classList.remove('hidden'); // Show button for admins
        } else {
            saveButton.classList.add('hidden');    // Hide for everyone else
        }

    } else {
        currentUser = null;
        authOverlay.classList.remove('hidden');
        mainAppContainer.classList.add('opacity-20', 'pointer-events-none');
    }
});

        // --- *** Dark Mode Logic *** ---
        function setDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            drawPolarPlotBasedOnMode();
        }

        darkModeToggle.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            setDarkMode(!isDarkMode);
        });

        if (document.documentElement.classList.contains('dark')) {
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
        } else {
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        }

        // --- NEW Helper: Populates the form from a data object ---
        function loadDataFromObject(loadedData) {
            try {
                // Restore header
                equipmentNameInput.value = loadedData.header.equipmentName || '';
                plantNameInput.value = loadedData.header.plantName || '';
                reportDateInput.value = loadedData.header.reportDate || new Date().toISOString().split('T')[0];

                // Restore details
                numVanesInput.value = loadedData.details.numVanes || '12';
                ratedPowerInput.value = loadedData.details.ratedPower || '';
                rotorRPMInput.value = loadedData.details.rotorRPM || '';
                rotorTypeSelect.value = loadedData.details.rotorType || '';
                rotorTypeSelect.dispatchEvent(new Event('change'));
                
                // --- NEW FIELDS ---
                document.getElementById('assetId').value = loadedData.details.assetId || '';
                document.getElementById('previousWeight').value = loadedData.details.previousWeight || '';
                
                // Check both root level (new saves) and details level (optional fallback)
                document.getElementById('analystRemarks').value = loadedData.remarks || '';

                if (loadedData.details.rotationDirection === "CW") {
                    rotDirCWButton.click();
                } else {
                    rotDirCCWButton.click();
                }

                // Restore suggestion inputs
                rotorWeightInput.value = loadedData.suggestion.rotorWeight || '';
                trialRadiusInput.value = loadedData.suggestion.trialRadius || '';

                // Restore balancing data object
                if (loadedData.balancingData) {
                    balancingData = loadedData.balancingData;
                }

                // Restore Global Reporting State
                if (loadedData.globalState) {
                    lastCalculationMode = loadedData.globalState.lastCalculationMode || 'N/A';
                    lastProcessedLocations = loadedData.globalState.lastProcessedLocations || [];
                    lastBalancingAction = loadedData.globalState.lastBalancingAction || 'add';
                    if(loadedData.globalState.measurementLocation) {
                        measurementLocationSelect.value = loadedData.globalState.measurementLocation;
                    }
                } 

                populateInputTables();
                updateGlobalTrialWeightFields();
                clearError();
                
                // Restore Action Radio Button
                if (lastBalancingAction === 'remove') {
                    document.getElementById('finalActionRemove').checked = true;
                } else {
                    document.getElementById('finalActionAdd').checked = true;
                }
                
                // Show/Hide Results logic
                const plotLoc = measurementLocationSelect.value;
                if (balancingData[plotLoc] && balancingData[plotLoc].correctionMass !== null) {
                     resultsDisplayDiv.classList.remove('hidden');
                     const d = balancingData[plotLoc];
                     correctionWeightMassSpan.textContent = d.correctionMass.toFixed(3);
                     correctionWeightAngleSpan.textContent = d.correctionAngle.toFixed(1);
                     document.getElementById('removalWeightMass').textContent = d.removalMass ? d.removalMass.toFixed(3) : '---';
                     document.getElementById('removalWeightAngle').textContent = d.removalAngle ? d.removalAngle.toFixed(1) : '---';
                     
                     if (lastCalculationMode.includes('Trim')) {
                        icResultsDiv.classList.add('hidden');
                        if(trimResultsDiv) trimResultsDiv.classList.remove('hidden'); 
                     } else {
                        icResultsDiv.classList.remove('hidden');
                        if(trimResultsDiv) trimResultsDiv.classList.add('hidden');
                     }
                } else {
                    resultsDisplayDiv.classList.add('hidden');
                }

                if (splitResultsDisplay) splitResultsDisplay.classList.add('hidden');
                
                plotLocationLabelSpan.textContent = measurementLocationSelect.value;
                currentLocSplittingSpan.textContent = measurementLocationSelect.value;
                prefillSplittingInputs();
                drawPolarPlotBasedOnMode();
                
                alert("Data loaded successfully!");
            } catch (err) {
                console.error("Error mapping data:", err);
                alert("Error loading data structure.");
            }
        }

        // --- Helper Functions ---
        function toRadians(degrees) { return degrees * (Math.PI / 180); }
        function toDegrees(radians) { return radians * (180 / Math.PI); }
        function normalizeAngle(degrees) {
            let angle = parseFloat(degrees) % 360;
            if (angle < 0) angle += 360;
            return angle;
        }
        function getInputValue(elementId, placeholder = "N/A") { 
            const el = document.getElementById(elementId);
            return (el && el.value) ? el.value : placeholder; 
        }
        function getSpanValue(elementId, placeholder = "---") { 
            const el = document.getElementById(elementId);
            return (el && el.textContent) ? el.textContent : placeholder;
        }

        // --- Robust Vector Class ---
        class Vector {
            constructor(magnitude, angleDeg) {
                this.magnitude = isNaN(parseFloat(magnitude)) ? 0 : parseFloat(magnitude);
                this.angleDeg = isNaN(parseFloat(angleDeg)) ? 0 : normalizeAngle(angleDeg);
                this.angleRad = toRadians(this.angleDeg);
                this.x = this.magnitude * Math.cos(this.angleRad);
                this.y = this.magnitude * Math.sin(this.angleRad);
            }
            static fromComponents(x, y) {
                const magnitude = Math.sqrt(x * x + y * y);
                const angleRad = Math.atan2(y, x);
                const angleDeg = toDegrees(angleRad);
                const vec = new Vector(magnitude, angleDeg);
                vec.x = x; vec.y = y;
                return vec;
            }
            add(v) { return Vector.fromComponents(this.x + v.x, this.y + v.y); }
            subtract(v) { return Vector.fromComponents(this.x - v.x, this.y - v.y); }
            multiply(v) {
                const newX = this.x * v.x - this.y * v.y;
                const newY = this.x * v.y + this.y * v.x;
                return Vector.fromComponents(newX, newY);
            }
            divide(v) {
                const denominator = v.magnitudeSquared;
                if (Math.abs(denominator) < 1e-12) { return new Vector(Infinity, 0); }
                const newX = (this.x * v.x + this.y * v.y) / denominator;
                const newY = (this.y * v.x - this.x * v.y) / denominator;
                return Vector.fromComponents(newX, newY);
            }
            get conjugate() { return Vector.fromComponents(this.x, -this.y); }
            get magnitudeSquared() { return this.x * this.x + this.y * this.y; }
            negate() { return Vector.fromComponents(-this.x, -this.y); }
            scale(scalar) { return Vector.fromComponents(this.x * scalar, this.y * scalar); }
        }

        function populateInputTables() {
            let stdHtml = '';
            let kicHtml = '';
            let trimHtml = '';

            for (const loc of locations) {
                const data = balancingData[loc];
                
                // --- Formatting Helper Logic (FIX for Point #1) ---
                // We ensure that if a value exists, it is formatted to fixed decimals strings
                // This fixes the "0.0310713..." vs "0.031" discrepancy.
                
                const o_amp = data.originalAmp !== null ? data.originalAmp : '';
                const o_ang = data.originalAngle !== null ? data.originalAngle : '';
                const f_amp = data.finalAmp !== null ? data.finalAmp : ''; 
                const f_ang = data.finalAngle !== null ? data.finalAngle : '';
                
                // Formatted display values for IC Magnitude (3 decimals)
                let displayICMag = '';
                if (data.calculatedICMag !== null) {
                    displayICMag = data.calculatedICMag.toFixed(3);
                } else if (data.knownICMag !== null) {
                    displayICMag = data.knownICMag.toFixed(3); // Applied formatting here
                }

                // Formatted display values for IC Angle (1 decimal)
                let displayICAng = '';
                if (data.calculatedICAngle !== null) {
                    displayICAng = data.calculatedICAngle.toFixed(1);
                } else if (data.knownICAngle !== null) {
                    displayICAng = data.knownICAngle.toFixed(1); // Applied formatting here
                }
                
                const trialRunAmp = data.trialRunAmp !== null ? data.trialRunAmp : '';
                const trialRunAngle = data.trialRunAngle !== null ? data.trialRunAngle : '';

                // Standard Table Row (Outputs are already spans, but we use the formatted vars for consistency)
                stdHtml += `
                    <tr class="align-middle">
                        <td class="px-2 py-1.5 text-center"><input type="checkbox" class="loc-checkbox-standard h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-location="${loc}"></td>
                        <td class="px-2 py-1.5 font-medium">${loc}</td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="std_o_amp_${loc}" value="${o_amp}" data-loc="${loc}" data-prop="originalAmp"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="std_o_phase_${loc}" value="${o_ang}" data-loc="${loc}" data-prop="originalAngle"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="std_ot_amp_${loc}" value="${trialRunAmp}" data-loc="${loc}" data-prop="trialRunAmp"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="std_ot_phase_${loc}" value="${trialRunAngle}" data-loc="${loc}" data-prop="trialRunAngle"></td>
                        <td class="px-2 py-1.5 text-center"><span class="table-output" id="std_ic_mag_${loc}">${data.calculatedICMag ? data.calculatedICMag.toFixed(3) : '---'}</span></td>
                        <td class="px-2 py-1.5 text-center"><span class="table-output" id="std_ic_ang_${loc}">${data.calculatedICAngle ? data.calculatedICAngle.toFixed(1) : '---'}</span></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="std_f_amp_${loc}" value="${f_amp}" data-loc="${loc}" data-prop="finalAmp"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="std_f_phase_${loc}" value="${f_ang}" data-loc="${loc}" data-prop="finalAngle"></td>
                    </tr>
                `;

                // Known IC Table Row (Updated to use displayICMag/Ang)
                kicHtml += `
                    <tr class="align-middle">
                        <td class="px-2 py-1.5 text-center"><input type="checkbox" class="loc-checkbox-knownic h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500" data-location="${loc}"></td>
                        <td class="px-2 py-1.5 font-medium">${loc}</td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="kic_o_amp_${loc}" value="${o_amp}" data-loc="${loc}" data-prop="originalAmp"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="kic_o_phase_${loc}" value="${o_ang}" data-loc="${loc}" data-prop="originalAngle"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="kic_ic_mag_${loc}" value="${displayICMag}" data-loc="${loc}" data-prop="knownICMag"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="kic_ic_ang_${loc}" value="${displayICAng}" data-loc="${loc}" data-prop="knownICAngle"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="kic_f_amp_${loc}" value="${f_amp}" data-loc="${loc}" data-prop="finalAmp"></td>
                        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="kic_f_phase_${loc}" value="${f_ang}" data-loc="${loc}" data-prop="finalAngle"></td>
                    </tr>
                `;

                // Trim Table Row (Updated to use displayICMag/Ang)
                trimHtml += `
    <tr class="align-middle">
        <td class="px-2 py-1.5 text-center"><input type="checkbox" class="loc-checkbox-trim h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" data-location="${loc}"></td>
        <td class="px-2 py-1.5 font-medium">${loc}</td>
        
        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="trim_res_amp_${loc}" value="${f_amp}" data-loc="${loc}" data-prop="finalAmp"></td>
        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input" id="trim_res_phase_${loc}" value="${f_ang}" data-loc="${loc}" data-prop="finalAngle"></td>
        
        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input bg-gray-100 dark:bg-gray-700" id="trim_ic_mag_${loc}" value="${displayICMag}" data-loc="${loc}" data-prop="knownICMag"></td>
        <td class="px-1 py-1.5"><input type="number" step="any" class="table-input bg-gray-100 dark:bg-gray-700" id="trim_ic_ang_${loc}" value="${displayICAng}" data-loc="${loc}" data-prop="knownICAngle"></td>
        
        <td class="px-1 py-1.5 border-l border-gray-200 dark:border-gray-700 pl-3">
            <input type="number" step="any" class="table-input border-indigo-300 dark:border-indigo-700" id="trim_final_amp_${loc}" value="${data.trimFinalAmp !== null ? data.trimFinalAmp : ''}" data-loc="${loc}" data-prop="trimFinalAmp" placeholder="Final">
        </td>
        <td class="px-1 py-1.5">
            <input type="number" step="any" class="table-input border-indigo-300 dark:border-indigo-700" id="trim_final_phase_${loc}" value="${data.trimFinalAngle !== null ? data.trimFinalAngle : ''}" data-loc="${loc}" data-prop="trimFinalAngle" placeholder="Final">
        </td>
    </tr>
`;
            }
            standardBalancingTableBody.innerHTML = stdHtml;
            knownIcTableBody.innerHTML = kicHtml;
            trimBalancingTableBody.innerHTML = trimHtml; 
            
            const stdHeaderCB = document.getElementById('selectAllStandard');
            const kicHeaderCB = document.getElementById('selectAllKnownIC');
            const trimHeaderCB = document.getElementById('selectAllTrim'); 

            if(stdHeaderCB) { stdHeaderCB.checked = false; stdHeaderCB.indeterminate = false; }
            if(kicHeaderCB) { kicHeaderCB.checked = false; kicHeaderCB.indeterminate = false; }
            if(trimHeaderCB) { trimHeaderCB.checked = false; trimHeaderCB.indeterminate = false; }
        }

        function updateResultsTables() {
            for (const loc of locations) {
                const data = balancingData[loc];
                const icMagSpan = document.getElementById(`std_ic_mag_${loc}`);
                const icAngSpan = document.getElementById(`std_ic_ang_${loc}`);
                if(icMagSpan) icMagSpan.textContent = (data.calculatedICMag && isFinite(data.calculatedICMag)) ? data.calculatedICMag.toFixed(3) : '---';
                if(icAngSpan) icAngSpan.textContent = (data.calculatedICAngle && isFinite(data.calculatedICAngle)) ? data.calculatedICAngle.toFixed(1) : '---';
            }
        }

        function storeTableDataToModel(e) {
            if (e.target.tagName !== 'INPUT' || !e.target.dataset.loc) return;

            const loc = e.target.dataset.loc;
            const prop = e.target.dataset.prop;
            const value = parseFloat(e.target.value);
            
            if (prop && loc && balancingData[loc]) {
                balancingData[loc][prop] = !isNaN(value) ? value : null;
                
                if (prop === 'originalAmp' || prop === 'originalAngle') {
                    const otherInputId = e.target.id.startsWith('std_') 
                        ? e.target.id.replace('std_', 'kic_') 
                        : e.target.id.replace('kic_', 'std_');
                    const otherInput = document.getElementById(otherInputId);
                    if (otherInput) otherInput.value = e.target.value;
                }
                
                if (prop === 'finalAmp' || prop === 'finalAngle') {
                    const inputsToUpdate = [
                        `std_f_${prop === 'finalAmp' ? 'amp' : 'phase'}_${loc}`,
                        `kic_f_${prop === 'finalAmp' ? 'amp' : 'phase'}_${loc}`,
                        `trim_res_${prop === 'finalAmp' ? 'amp' : 'phase'}_${loc}`
                    ];
                    inputsToUpdate.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && el !== e.target) el.value = e.target.value;
                    });
                }

                if (prop === 'knownICMag' || prop === 'knownICAngle') {
                     const inputsToUpdate = [
                        `kic_ic_${prop === 'knownICMag' ? 'mag' : 'ang'}_${loc}`,
                        `trim_ic_${prop === 'knownICMag' ? 'mag' : 'ang'}_${loc}`
                    ];
                     inputsToUpdate.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && el !== e.target) el.value = e.target.value;
                    });
                }
            }
        }


        // --- UI Update Functions ---
        function initializeData() {
            balancingData.trialWeight = { mass: null, angle: null };
            locations.forEach(loc => {
                balancingData[loc] = {
                    originalAmp: null, originalAngle: null,
                    trialRunAmp: null, trialRunAngle: null,
                    knownICMag: null, knownICAngle: null,
                    calculatedICMag: null, calculatedICAngle: null, 
                    correctionMass: null, correctionAngle: null,
                    removalMass: null, removalAngle: null,
                    finalAmp: null, finalAngle: null,
                    trimFinalAmp: null, trimFinalAngle: null,
                    lastOriginalForPlot: null, 
                    initialCorrectionMass: null, // NEW
                    initialCorrectionAngle: null, // NEW
                    trimCorrectionMass: null,    // NEW
                    trimCorrectionAngle: null,
                };
            });
            
            numVanesInput.value = "12";
            measurementLocationSelect.value = "IBH";
            ratedPowerInput.value = '';
            rotorRPMInput.value = ''; 
            rotorTypeSelect.value = '';
            rotorTypeImage.classList.add('hidden');
            rotorTypeImage.src = '';
            // --- NEW FIELDS ---
            document.getElementById('assetId').value = '';
            document.getElementById('previousWeight').value = '';
            // --- NEW: Clear Remarks ---
            document.getElementById('analystRemarks').value = '';

            if (rotationDirectionInput.value === "CW") { 
                 rotDirCWButton.click(); 
            } else {
                 rotDirCCWButton.click(); 
            }
            
            rotorWeightInput.value = '';
            trialRadiusInput.value = '';
            suggestedTrialWeightResultP.textContent = '';
            trialWeightSuggestionContainerDiv.classList.remove('hidden');
            toggleTrialWeightSectionButton.textContent = "Hide Trial Weight Calculator";

            resultsDisplayDiv.classList.add('hidden');
            predictedResidualsDisplayDiv.classList.add('hidden'); 
            errorMessageDiv.classList.add('hidden');
            
            if(trimResultsDiv) trimResultsDiv.classList.add('hidden');

            equipmentNameInput.value = '';
            plantNameInput.value = '';
            reportDateInput.value = new Date().toISOString().split('T')[0]; 

            splitWcMassInput.value = '';
            splitWcAngleInput.value = '';
            splitNumHolesInput.value = numVanesInput.value || '12'; 
            splitFirstHoleAngleInput.value = '0';
            if(splitResultsDisplayDiv) splitResultsDisplayDiv.classList.add('hidden');
            if(splitErrorMessageP) splitErrorMessageP.classList.add('hidden');
            if(splitErrorMessageP) splitErrorMessageP.textContent = '';
            splitWeightResults = { w1: null, w2: null };
            document.getElementById('trialWeightRemovedCheckbox').checked = false;
            document.getElementById('strategyRemove').checked = true;

            populateInputTables();
        }
        
        function updateGlobalTrialWeightFields() {
            trialWeightMassInput.value = balancingData.trialWeight.mass !== null ? balancingData.trialWeight.mass : '';
            trialWeightAngleInput.value = balancingData.trialWeight.angle !== null ? balancingData.trialWeight.angle : '';
        }

        function displayError(message, target = 'general') {
            if (target === 'general') {
                errorTextSpan.textContent = message;
                errorMessageDiv.classList.remove('hidden');
                resultsDisplayDiv.classList.add('hidden');
                predictedResidualsDisplayDiv.classList.add('hidden');
                if (splitResultsDisplay) splitResultsDisplay.classList.add('hidden');
            } else if (target === 'splitting') {
                splitErrorMessageP.textContent = message;
                splitErrorMessageP.classList.remove('hidden');
                if (splitResultsDisplay) splitResultsDisplay.classList.add('hidden');
            }
        }

        function clearError(target = 'all') {
             predictedResidualsDisplayDiv.classList.add('hidden'); 
             predictedResidualsListSpan.textContent = ''; 
            if (target === 'all' || target === 'general') {
                errorMessageDiv.classList.add('hidden');
                errorTextSpan.textContent = '';
            }
            if (target === 'all' || target === 'splitting') {
                if (splitErrorMessageP) {
                    splitErrorMessageP.classList.add('hidden');
                    splitErrorMessageP.textContent = '';
                }
            }
        }
        
        function resetAllFields() {
            initializeData(); 
            updateGlobalTrialWeightFields();
            resultsDisplayDiv.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            icMagnitudeSpan.textContent = '---';
            icAngleSpan.textContent = '---';
            correctionWeightMassSpan.textContent = '---';
            correctionWeightAngleSpan.textContent = '---';
            drawPolarPlotBasedOnMode();
            switchTab(tabStandardButton, contentStandardDiv); 
        }


        // --- Event Listeners ---
        function switchTab(activeTabButton, activeContentDiv) {
            [tabStandardButton, tabKnownICButton, tabTrimButton, tabSplittingButton, tabAboutButton].forEach(btn => btn.classList.remove('active'));
            [contentStandardDiv, contentKnownICDiv, contentTrimDiv, contentSplittingDiv, contentAboutDiv].forEach(content => content.classList.add('hidden'));
            
            if (activeTabButton.id === 'tabAbout') {
                polarPlotColumn.classList.add('hidden');
            } else {
                polarPlotColumn.classList.remove('hidden');
            }

            activeTabButton.classList.add('active');
            activeContentDiv.classList.remove('hidden');
            
            clearError(); 
            if (activeTabButton.id !== 'tabSplitting' && splitResultsDisplay) {
                splitResultsDisplay.classList.add('hidden');
            }
            if (activeTabButton.id !== 'tabStandard' && activeTabButton.id !== 'tabKnownIC' && activeTabButton.id !== 'tabTrim') {
                resultsDisplayDiv.classList.add('hidden');
            }
            
            drawPolarPlotBasedOnMode();
        }
        
        tabStandardButton.addEventListener('click', () => switchTab(tabStandardButton, contentStandardDiv));
        tabKnownICButton.addEventListener('click', () => {
            switchTab(tabKnownICButton, contentKnownICDiv);
            // Pre-fill logic
            for (const loc of locations) {
                const data = balancingData[loc];
                if (data.calculatedICMag && !data.knownICMag) {
                    const icMagInput = document.getElementById(`kic_ic_mag_${loc}`);
                    if (icMagInput) icMagInput.value = data.calculatedICMag.toFixed(3);
                    balancingData[loc].knownICMag = data.calculatedICMag;
                }
                if (data.calculatedICAngle && !data.knownICAngle) {
                    const icAngInput = document.getElementById(`kic_ic_ang_${loc}`);
                    if (icAngInput) icAngInput.value = data.calculatedICAngle.toFixed(1);
                    balancingData[loc].knownICAngle = data.calculatedICAngle;
                }
            }
        });
        tabTrimButton.addEventListener('click', () => {
            switchTab(tabTrimButton, contentTrimDiv);
            const plotLoc = measurementLocationSelect.value;
            const data = balancingData[plotLoc];
             if (data.correctionMass !== null) {
                trimPrevMassInput.value = data.correctionMass.toFixed(3);
                trimPrevAngleInput.value = data.correctionAngle.toFixed(1);
            }
        });
        tabSplittingButton.addEventListener('click', () => {
            switchTab(tabSplittingButton, contentSplittingDiv);
            prefillSplittingInputs();
        });
        tabAboutButton.addEventListener('click', () => switchTab(tabAboutButton, contentAboutDiv));


        toggleTrialWeightSectionButton.addEventListener('click', () => {
            trialWeightSuggestionContainerDiv.classList.toggle('hidden');
            if (trialWeightSuggestionContainerDiv.classList.contains('hidden')) {
                toggleTrialWeightSectionButton.textContent = "Show Trial Weight Calculator";
            } else {
                toggleTrialWeightSectionButton.textContent = "Hide Trial Weight Calculator";
            }
        });

        rotDirCCWButton.addEventListener('click', () => {
            rotationDirectionInput.value = "CCW";
            rotDirCCWButton.classList.replace('bg-gray-300', 'bg-sky-600');
            rotDirCCWButton.classList.add('text-white');
            rotDirCCWButton.classList.remove('hover:bg-gray-400', 'dark:bg-gray-600', 'dark:hover:bg-gray-500');
            rotDirCWButton.classList.replace('bg-sky-600', 'bg-gray-300');
            rotDirCWButton.classList.remove('text-white');
            rotDirCWButton.classList.add('hover:bg-gray-400', 'dark:bg-gray-600', 'dark:hover:bg-gray-500');
            rotationDirectionArrowDiv.innerHTML = "CCW ↺";
            drawPolarPlotBasedOnMode();
        });
        rotDirCWButton.addEventListener('click', () => {
            rotationDirectionInput.value = "CW";
            rotDirCWButton.classList.replace('bg-gray-300', 'bg-sky-600');
            rotDirCWButton.classList.add('text-white');
            rotDirCWButton.classList.remove('hover:bg-gray-400', 'dark:bg-gray-600', 'dark:hover:bg-gray-500');
            rotDirCCWButton.classList.replace('bg-sky-600', 'bg-gray-300');
            rotDirCCWButton.classList.remove('text-white');
            rotDirCCWButton.classList.add('hover:bg-gray-400', 'dark:bg-gray-600', 'dark:hover:bg-gray-500');
            rotationDirectionArrowDiv.innerHTML = "CW ↻";
            drawPolarPlotBasedOnMode();
        });

        rotorTypeSelect.addEventListener('change', (e) => {
            const selectedType = e.target.value;
           // --- DISABLE IMAGE POPUP ---
            // Commenting out logic to stop image from showing
            /*
            if (selectedType && rotorTypeImageSources[selectedType]) {
                rotorTypeImage.src = rotorTypeImageSources[selectedType];
                rotorTypeImage.alt = selectedType + " Rotor Image";
                rotorTypeImage.classList.remove('hidden');
            } else {
                rotorTypeImage.classList.add('hidden');
                rotorTypeImage.src = '';
                rotorTypeImage.alt = 'Rotor Type Image';
            }
            */
        });

        measurementLocationSelect.addEventListener('change', (e) => {
            const newLocation = e.target.value;
            currentLocSplittingSpan.textContent = newLocation;
            plotLocationLabelSpan.textContent = newLocation;
            prefillSplittingInputs();
            resultsDisplayDiv.classList.add('hidden'); 
            if (splitResultsDisplay) splitResultsDisplay.classList.add('hidden');
            clearError();
            drawPolarPlotBasedOnMode(); 
        });

        numVanesInput.addEventListener('change', () => {
            if (splitNumHolesInput) splitNumHolesInput.value = numVanesInput.value; 
            drawPolarPlotBasedOnMode();
        });
        
        trimMergeCheckbox.addEventListener('change', (e) => {
            if(e.target.checked) {
                trimPreviousWeightInputs.classList.remove('hidden');
            } else {
                trimPreviousWeightInputs.classList.add('hidden');
            }
        });


        // --- Event Delegation ---
        standardBalancingTableBody.addEventListener('change', storeTableDataToModel);
        knownIcTableBody.addEventListener('change', storeTableDataToModel);
        trimBalancingTableBody.addEventListener('change', storeTableDataToModel);
        
        [trialWeightMassInput, trialWeightAngleInput].forEach(input => {
            if (input) input.addEventListener('change', () => {
                balancingData.trialWeight.mass = parseFloat(trialWeightMassInput.value) || null;
                balancingData.trialWeight.angle = parseFloat(trialWeightAngleInput.value) || null;
            });
        });
        
        suggestTrialWeightButton.addEventListener('click', () => {
            const rotorMassKg = parseFloat(rotorWeightInput.value);
            const radiusMm = parseFloat(trialRadiusInput.value);
            const rpm = parseFloat(rotorRPMInput.value); 
            if (isNaN(rotorMassKg) || isNaN(radiusMm) || isNaN(rpm) || rotorMassKg <= 0 || radiusMm <= 0 || rpm <= 0) {
                suggestedTrialWeightResultP.textContent = "Error: Valid rotor weight, radius (trial), and RPM (equipment) required.";
                suggestedTrialWeightResultP.classList.add('text-red-600', 'dark:text-red-400');
                suggestedTrialWeightResultP.classList.remove('text-indigo-800', 'dark:text-indigo-200');
                return;
            }
            suggestedTrialWeightResultP.classList.remove('text-red-600', 'dark:text-red-400');
            suggestedTrialWeightResultP.classList.add('text-indigo-800', 'dark:text-indigo-200');
            const omega = rpm * 2 * Math.PI / 60; 
            const radiusM = radiusMm / 1000; 
            let suggestedMassKg = (0.05 * rotorMassKg * 9.81) / (radiusM * omega * omega); 
            let suggestedMassGrams = suggestedMassKg * 1000;
            if (isNaN(suggestedMassGrams) || !isFinite(suggestedMassGrams) || suggestedMassGrams <=0) {
                 suggestedTrialWeightResultP.textContent = `Could not calculate. Check inputs. (Calc: ${suggestedMassGrams.toFixed(2)} g)`;
                 return;
            }
            suggestedTrialWeightResultP.textContent = `Suggested trial weight: ~${suggestedMassGrams.toFixed(1)} grams. Adjust as needed.`;
        });

        // --- Calculation Logic ---

        function displayPredictedResiduals(cwVector, icData, processedLocations, baseVectorType = 'original') {
            let residualsText = [];
            for (const loc of processedLocations) {
                const data = balancingData[loc];
                const baseAmp = (baseVectorType === 'trial') ? data.trialRunAmp : data.originalAmp;
                const baseAngle = (baseVectorType === 'trial') ? data.trialRunAngle : data.originalAngle;
                const O_i = new Vector(baseAmp, baseAngle);
                const alpha_i = icData[loc];
                if (O_i.magnitude > 1e-9 && alpha_i) {
                    const predictedChange = alpha_i.multiply(cwVector);
                    const R_i = O_i.add(predictedChange);
                    residualsText.push(`<strong>${loc}:</strong> ${R_i.magnitude.toFixed(2)}`);
                } else {
                     residualsText.push(`<strong>${loc}:</strong> N/A`);
                }
            }
            predictedResidualsListSpan.innerHTML = residualsText.join(', ');
            predictedResidualsDisplayDiv.classList.remove('hidden');
        }

        // *** STANDARD CALCULATION ***
        calculateStandardButton.addEventListener('click', () => {
            clearError();
            resultsDisplayDiv.classList.add('hidden');
            
            const Wt_mass = parseFloat(trialWeightMassInput.value);
            let Wt_ang = parseFloat(trialWeightAngleInput.value);
            const isTrialWeightRemoved = document.getElementById('trialWeightRemovedCheckbox').checked;
            if (isTrialWeightRemoved) Wt_ang = normalizeAngle(Wt_ang + 180);

            if (isNaN(Wt_mass) || isNaN(Wt_ang)) { displayError("Trial Weight (Mass and Angle) must be valid numbers."); return; }
            if (Wt_mass <= 1e-9) { displayError("Trial weight mass must be positive."); return; }
            
            const Wt_vec = new Vector(Wt_mass, Wt_ang);
            const correctionStrategy = document.querySelector('input[name="correctionStrategy"]:checked').value;

            const checkedRows = document.querySelectorAll('.loc-checkbox-standard:checked');
            if (checkedRows.length === 0) { displayError("Select at least one location from the table to calculate."); return; }
            const locsToProcess = Array.from(checkedRows).map(cb => cb.dataset.location);

            let CW_vec = null, allInfluenceCoefficients = {}, missingData = false;

            for (const loc of locsToProcess) {
                const data = balancingData[loc];
                if (data.originalAmp === null || data.originalAngle === null || data.trialRunAmp === null || data.trialRunAngle === null) {
                    missingData = true; 
                    displayError(`Missing data for checked location: ${loc}. Please fill O Amp, O Phase, O+T Amp, and O+T Phase.`);
                    break;
                }
                const O_i = new Vector(data.originalAmp, data.originalAngle), OT_i = new Vector(data.trialRunAmp, data.trialRunAngle);
                const V_i = OT_i.subtract(O_i), alpha_i = V_i.divide(Wt_vec);
                allInfluenceCoefficients[loc] = alpha_i;
                balancingData[loc].calculatedICMag = alpha_i.magnitude;
                balancingData[loc].calculatedICAngle = alpha_i.angleDeg;
                balancingData[loc].lastOriginalForPlot = O_i;
            }
            if (missingData) return;

            if (locsToProcess.length === 1) {
                const loc = locsToProcess[0];
                const O_vec = new Vector(balancingData[loc].originalAmp, balancingData[loc].originalAngle);
                const OT_vec = new Vector(balancingData[loc].trialRunAmp, balancingData[loc].trialRunAngle);
                const IC_vec = allInfluenceCoefficients[loc];
                let targetVibrationVector = (correctionStrategy === 'keep') ? OT_vec : O_vec;
                
                if (IC_vec.magnitude < 1e-12) {
                    displayError("IC magnitude is near zero. Cannot calculate correction weight accurately.");
                    CW_vec = new Vector(0,0);
                } else {
                    CW_vec = targetVibrationVector.negate().divide(IC_vec);
                }
                resultsTitle.innerHTML = 'Calculated Results (for <span id="resultLocation" class="font-bold"></span>)';
                resultLocationSpan.textContent = loc;
            } else {
                let sum_O_alpha_conjugate = Vector.fromComponents(0, 0), sum_alpha_mag_squared = 0;
                for (const loc of locsToProcess) {
                    const data = balancingData[loc], alpha_i = allInfluenceCoefficients[loc];
                    let targetVibrationVector = (correctionStrategy === 'keep') ? new Vector(data.trialRunAmp, data.trialRunAngle) : new Vector(data.originalAmp, data.originalAngle);
                    sum_O_alpha_conjugate = sum_O_alpha_conjugate.add(targetVibrationVector.multiply(alpha_i.conjugate));
                    sum_alpha_mag_squared += alpha_i.magnitudeSquared;
                }
                if (Math.abs(sum_alpha_mag_squared) < 1e-12) { displayError("Cannot calculate (Least Squares): Sum of IC magnitudes is zero."); return; }
                CW_vec = sum_O_alpha_conjugate.negate().scale(1 / sum_alpha_mag_squared);
                resultsTitle.innerHTML = 'Overall Least Squares Results';
                resultLocationSpan.textContent = `${locsToProcess.length} Locations`;
            }
            
            lastCalculationMode = 'Standard (with Trial Run)';
            lastProcessedLocations = locsToProcess;

            const CW_remove_vec = CW_vec.negate();
            const removeMass = CW_remove_vec.magnitude;
            const removeAngle = CW_remove_vec.angleDeg;
            
            const corrMass = CW_vec.magnitude, corrAngle = CW_vec.angleDeg;
            const plotLocation = measurementLocationSelect.value; 
            
            balancingData[plotLocation].correctionMass = corrMass;
            balancingData[plotLocation].correctionAngle = corrAngle;
            balancingData[plotLocation].removalMass = removeMass;
            balancingData[plotLocation].removalAngle = removeAngle;
            balancingData[plotLocation].initialCorrectionMass = corrMass;
            balancingData[plotLocation].initialCorrectionAngle = corrAngle;

            const addLabel = (correctionStrategy === 'keep') ? "Add Weight:" : "Total Correction (Wc):";
            const removeLabel = (correctionStrategy === 'keep') ? "OR Remove:" : "OR Remove Total:";
            correctionWeightLabel.textContent = addLabel;
            document.getElementById('removalWeightLabel').textContent = removeLabel;

            const currentIC = allInfluenceCoefficients[plotLocation]; 
            if (currentIC && isFinite(currentIC.magnitude)) {
                icLocationLabelSpan.textContent = `(for ${plotLocation})`;
                icMagnitudeSpan.textContent = currentIC.magnitude.toFixed(3);
                icAngleSpan.textContent = currentIC.angleDeg.toFixed(1);
                icResultsDiv.classList.remove('hidden');
            } else {
                icResultsDiv.classList.add('hidden');
            }

            correctionWeightMassSpan.textContent = corrMass.toFixed(3);
            correctionWeightAngleSpan.textContent = corrAngle.toFixed(1);

            document.getElementById('removalWeightMass').textContent = removeMass.toFixed(3);
            document.getElementById('removalWeightAngle').textContent = removeAngle.toFixed(1);
            document.getElementById('correctionWeightRemovalResults').classList.remove('hidden');

            resultsDisplayDiv.classList.remove('hidden');
            
            const baseType = (correctionStrategy === 'keep') ? 'trial' : 'original';
            displayPredictedResiduals(CW_vec, allInfluenceCoefficients, locsToProcess, baseType);

            updateResultsTables();
            prefillSplittingInputs();
            drawPolarPlotBasedOnMode();
        });

        // *** KNOWN IC CALCULATION ***
        calculateKnownICButton.addEventListener('click', () => {
            clearError();
            resultsDisplayDiv.classList.add('hidden');

            const checkedRows = document.querySelectorAll('.loc-checkbox-knownic:checked');
            if (checkedRows.length === 0) { displayError("Select at least one location from the table to calculate."); return; }
            const locsToProcess = Array.from(checkedRows).map(cb => cb.dataset.location);

            let CW_vec = null, allInfluenceCoefficients = {}, missingData = false;

            for (const loc of locsToProcess) {
                const data = balancingData[loc];
                const { originalAmp: O_amp, originalAngle: O_ang, knownICMag: IC_mag, knownICAngle: IC_ang } = data;
                if (O_amp === null || O_ang === null || IC_mag === null || IC_ang === null) {
                    missingData = true;
                    displayError(`Missing data for checked location: ${loc}. Please fill O Amp, O Phase, Known IC Mag, and Known IC Angle.`);
                    break;
                }
                if (IC_mag <= 1e-9) {
                     missingData = true;
                     displayError(`Known IC Magnitude for ${loc} must be positive and non-zero.`);
                     break;
                }
                const O_i = new Vector(O_amp, O_ang), alpha_i = new Vector(IC_mag, IC_ang);
                allInfluenceCoefficients[loc] = alpha_i;
                balancingData[loc].lastOriginalForPlot = O_i;
            }
            if (missingData) return;

            if (locsToProcess.length === 1) {
                const loc = locsToProcess[0];
                const O_vec = new Vector(balancingData[loc].originalAmp, balancingData[loc].originalAngle);
                const IC_vec = allInfluenceCoefficients[loc];
                CW_vec = O_vec.negate().divide(IC_vec);
                resultsTitle.innerHTML = 'Calculated Results (for <span id="resultLocation" class="font-bold"></span>)';
                resultLocationSpan.textContent = loc;
            } else {
                let sum_O_alpha_conjugate = Vector.fromComponents(0, 0), sum_alpha_mag_squared = 0;
                for (const loc of locsToProcess) {
                    const O_i = new Vector(balancingData[loc].originalAmp, balancingData[loc].originalAngle);
                    const alpha_i = allInfluenceCoefficients[loc];
                    sum_O_alpha_conjugate = sum_O_alpha_conjugate.add(O_i.multiply(alpha_i.conjugate));
                    sum_alpha_mag_squared += alpha_i.magnitudeSquared;
                }
                if (Math.abs(sum_alpha_mag_squared) < 1e-12) { displayError("Cannot calculate (Least Squares): Sum of IC magnitudes is zero."); return; }
                CW_vec = sum_O_alpha_conjugate.negate().scale(1 / sum_alpha_mag_squared);
                resultsTitle.innerHTML = 'Overall Least Squares Results';
                resultLocationSpan.textContent = `${locsToProcess.length} Locations`;
            }
            
            lastCalculationMode = 'Known Influence Coefficient';
            lastProcessedLocations = locsToProcess;

            const CW_remove_vec = CW_vec.negate();
            const removeMass = CW_remove_vec.magnitude;
            const removeAngle = CW_remove_vec.angleDeg;

            const corrMass = CW_vec.magnitude, corrAngle = CW_vec.angleDeg;
            const plotLocation = measurementLocationSelect.value; 

            balancingData[plotLocation].correctionMass = corrMass;
            balancingData[plotLocation].correctionAngle = corrAngle;
            balancingData[plotLocation].removalMass = removeMass;
            balancingData[plotLocation].removalAngle = removeAngle;
            balancingData[plotLocation].initialCorrectionMass = corrMass;
            balancingData[plotLocation].initialCorrectionAngle = corrAngle;

            correctionWeightLabel.textContent = "Correction Weight (Wc):";
            document.getElementById('removalWeightLabel').textContent = "OR Remove Weight:";

            icResultsDiv.classList.add('hidden');

            correctionWeightMassSpan.textContent = corrMass.toFixed(3);
            correctionWeightAngleSpan.textContent = corrAngle.toFixed(1);

            document.getElementById('removalWeightMass').textContent = removeMass.toFixed(3);
            document.getElementById('removalWeightAngle').textContent = removeAngle.toFixed(1);
            document.getElementById('correctionWeightRemovalResults').classList.remove('hidden');
            
            resultsDisplayDiv.classList.remove('hidden');
            
            displayPredictedResiduals(CW_vec, allInfluenceCoefficients, locsToProcess, 'original');

            prefillSplittingInputs();
            drawPolarPlotBasedOnMode();
        });
        
        // *** TRIM CALCULATION (MULTI-POINT) ***
        calculateTrimButton.addEventListener('click', () => {
            clearError();
            trimResultsDiv.classList.add('hidden');

            const checkedRows = document.querySelectorAll('.loc-checkbox-trim:checked');
            if (checkedRows.length === 0) { 
                displayError("Select at least one location from the table to calculate Trim."); 
                return; 
            }
            const locsToProcess = Array.from(checkedRows).map(cb => cb.dataset.location);

            let missingData = false;
            let sum_Res_alpha_conjugate = Vector.fromComponents(0, 0);
            let sum_alpha_mag_squared = 0;
            let singleLocResidual = null;
            let singleLocIC = null;

            for (const loc of locsToProcess) {
                const data = balancingData[loc];
                const resAmp = data.finalAmp;
                const resAng = data.finalAngle;
                const icMag = (data.calculatedICMag !== null && isFinite(data.calculatedICMag)) ? data.calculatedICMag : data.knownICMag;
                const icAng = (data.calculatedICAngle !== null && isFinite(data.calculatedICAngle)) ? data.calculatedICAngle : data.knownICAngle;

                if (resAmp === null || resAng === null || icMag === null || icAng === null) {
                    missingData = true;
                    displayError(`Missing data for ${loc}. Please ensure Residuals and ICs are populated.`);
                    break;
                }
                if (icMag <= 1e-9) {
                     missingData = true;
                     displayError(`IC Magnitude for ${loc} is zero. Cannot calculate.`);
                     break;
                }

                const Res_vec = new Vector(resAmp, resAng);
                const IC_vec = new Vector(icMag, icAng);
                sum_Res_alpha_conjugate = sum_Res_alpha_conjugate.add(Res_vec.multiply(IC_vec.conjugate));
                sum_alpha_mag_squared += IC_vec.magnitudeSquared;
                
                singleLocResidual = Res_vec;
                singleLocIC = IC_vec;
                
                balancingData[loc].lastOriginalForPlot = Res_vec; 
            }

            if (missingData) return;

            let W_trim = null;

            if (locsToProcess.length === 1) {
                W_trim = singleLocResidual.negate().divide(singleLocIC);
            } else {
                if (Math.abs(sum_alpha_mag_squared) < 1e-12) {
                    displayError("Sum of IC magnitudes is zero."); return;
                }
                W_trim = sum_Res_alpha_conjugate.negate().scale(1 / sum_alpha_mag_squared);
            }

            document.getElementById('trimMassResult').textContent = W_trim.magnitude.toFixed(3);
            document.getElementById('trimAngleResult').textContent = W_trim.angleDeg.toFixed(1);
            trimResultsDiv.classList.remove('hidden');
            
            const plotLocation = measurementLocationSelect.value; // Define variable first!
            
            // Save the separate Trim Weight
            balancingData[plotLocation].trimCorrectionMass = W_trim.magnitude;
            balancingData[plotLocation].trimCorrectionAngle = W_trim.angleDeg;
            balancingData[plotLocation].isTrimMerged = false; // New Flag
            // ---------------------------------

            const trimSoloDiv = document.getElementById('trimSoloResult');
            const trimMergedDiv = document.getElementById('trimMergedResult');

            if (trimMergeCheckbox.checked) {
                const prevMass = parseFloat(trimPrevMassInput.value);
                const prevAngle = parseFloat(trimPrevAngleInput.value);

                if (!isNaN(prevMass) && !isNaN(prevAngle)) {
                    const W_prev = new Vector(prevMass, prevAngle);
                    const W_total = W_prev.add(W_trim);

                    document.getElementById('trimTotalMassResult').textContent = W_total.magnitude.toFixed(3);
                    document.getElementById('trimTotalAngleResult').textContent = W_total.angleDeg.toFixed(1);
                    
                    trimSoloDiv.classList.add('opacity-50'); 
                    trimMergedDiv.classList.remove('hidden');
                    
                    const plotLoc = measurementLocationSelect.value; 
                    // Main Correction Mass (Action Taken uses this)
                    balancingData[plotLoc].correctionMass = W_total.magnitude;
                    balancingData[plotLoc].correctionAngle = W_total.angleDeg;
                    
                    // --- FIX FOR ISSUE 2: Update Trim Storage to Total if Merged ---
                    balancingData[plotLoc].trimCorrectionMass = W_total.magnitude;
                    balancingData[plotLoc].trimCorrectionAngle = W_total.angleDeg;
                    balancingData[plotLoc].isTrimMerged = true; // Set Flag
                    // ---------------------------------------------------------------
                    
                    const W_remove = W_total.negate();
                    balancingData[plotLoc].removalMass = W_remove.magnitude;
                    balancingData[plotLoc].removalAngle = W_remove.angleDeg;
                }
            } else {
                trimMergedDiv.classList.add('hidden');
                trimSoloDiv.classList.remove('opacity-50');
                
                const plotLoc = measurementLocationSelect.value; 
                balancingData[plotLoc].correctionMass = W_trim.magnitude;
                balancingData[plotLoc].correctionAngle = W_trim.angleDeg;
                const W_remove = W_trim.negate();
                balancingData[plotLoc].removalMass = W_remove.magnitude;
                balancingData[plotLoc].removalAngle = W_remove.angleDeg;
            }

            //lastCalculationMode = 'Trim Balance (Multi-Point)';
            if (!lastCalculationMode.includes('+Trim')) {
              lastCalculationMode += '+Trim';
              }
              
            lastProcessedLocations = locsToProcess;

            plotLocationLabelSpan.textContent = measurementLocationSelect.value;
            drawPolarPlotBasedOnMode();
        });


        function prefillSplittingInputs() {
            const currentLocation = measurementLocationSelect.value;
            currentLocSplittingSpan.textContent = currentLocation;
            const data = balancingData[currentLocation];
            if (data && data.correctionMass !== null && isFinite(data.correctionMass)) {
                splitWcMassInput.value = data.correctionMass.toFixed(3);
                splitWcAngleInput.value = data.correctionAngle.toFixed(1);
            } else {
                splitWcMassInput.value = '';
                splitWcAngleInput.value = '';
            }
            splitNumHolesInput.value = numVanesInput.value || '12'; 
        }
        
        calculateSplitWeightsButton.addEventListener('click', () => {
            clearError('splitting');
            splitResultsDisplayDiv.classList.add('hidden');
            splitWeightResults = { w1: null, w2: null }; 
            const wcMass = parseFloat(splitWcMassInput.value), wcAngleDeg = parseFloat(splitWcAngleInput.value);
            const numHoles = parseInt(splitNumHolesInput.value), firstHoleAngleDeg = parseFloat(splitFirstHoleAngleInput.value);
            if (isNaN(wcMass) || isNaN(wcAngleDeg) || isNaN(numHoles) || isNaN(firstHoleAngleDeg)) { displayError("Splitting: All input fields for splitting must be valid numbers.", 'splitting'); return; }
            if (wcMass <= 0) { displayError("Correction weight mass to split must be positive.", 'splitting'); return; }
            if (numHoles <= 1) { displayError("Number of available locations must be at least 2.", 'splitting'); return; }
            const angleIncrementDeg = 360 / numHoles;
            let holeAnglesDeg = [];
            for (let i = 0; i < numHoles; i++) { holeAnglesDeg.push(normalizeAngle(firstHoleAngleDeg + i * angleIncrementDeg)); }
            let thetaA_deg = -1, thetaB_deg = -1, mass1 = 0, mass2 = 0;
            const sortedHoleAnglesDeg = [...holeAnglesDeg].sort((a,b) => normalizeAngle(a - firstHoleAngleDeg) - normalizeAngle(b-firstHoleAngleDeg) );
            for (let i = 0; i < numHoles; i++) {
                const currentHole = sortedHoleAnglesDeg[i], nextHole = sortedHoleAnglesDeg[(i + 1) % numHoles]; 
                let wc_is_between = (currentHole <= nextHole) ? (wcAngleDeg >= currentHole && wcAngleDeg <= nextHole) : (wcAngleDeg >= currentHole || wcAngleDeg <= nextHole);
                if (wc_is_between) { thetaA_deg = currentHole; thetaB_deg = nextHole; break; }
            }
            if (thetaA_deg === -1) {
                 const exactMatchIndex = sortedHoleAnglesDeg.findIndex(h => Math.abs(normalizeAngle(h - wcAngleDeg)) < 0.01 || Math.abs(normalizeAngle(h - wcAngleDeg) - 360) < 0.01);
                 if (exactMatchIndex !== -1) { thetaA_deg = sortedHoleAnglesDeg[exactMatchIndex]; thetaB_deg = sortedHoleAnglesDeg[(exactMatchIndex + 1) % numHoles]; } 
                 else { thetaA_deg = sortedHoleAnglesDeg[numHoles - 1]; thetaB_deg = sortedHoleAnglesDeg[0]; }
            }
            if (Math.abs(normalizeAngle(wcAngleDeg - thetaA_deg)) < 0.01) { mass1 = wcMass; mass2 = 0; } 
            else if (Math.abs(normalizeAngle(wcAngleDeg - thetaB_deg)) < 0.01) { mass1 = 0; mass2 = wcMass; } 
            else if (Math.abs(normalizeAngle(thetaA_deg - thetaB_deg)) < 0.01 && numHoles > 1) { displayError("Cannot split, bracketing holes are effectively the same.", 'splitting'); return; }
            else {
                const beta = toRadians(normalizeAngle(thetaB_deg - wcAngleDeg)), gamma = toRadians(normalizeAngle(wcAngleDeg - thetaA_deg)), alpha = toRadians(normalizeAngle(thetaB_deg - thetaA_deg)); 
                if (Math.abs(Math.sin(alpha)) < 1e-9) { displayError("Cannot split, locations are co-linear (0 or 180 deg apart).", 'splitting'); return; }
                mass1 = wcMass * Math.sin(beta) / Math.sin(alpha); mass2 = wcMass * Math.sin(gamma) / Math.sin(alpha);
            }
            if (mass1 < -1e-9 || mass2 < -1e-9) { displayError(`Calculated split masses are negative. Wc may not be between selected holes.`, 'splitting'); return; }
            if (Math.abs(mass1) < 1e-9) mass1 = 0; if (Math.abs(mass2) < 1e-9) mass2 = 0;
            splitWeight1MassSpan.textContent = mass1.toFixed(3); splitWeight1AngleSpan.textContent = thetaA_deg.toFixed(1);
            splitWeight2MassSpan.textContent = mass2.toFixed(3); splitWeight2AngleSpan.textContent = thetaB_deg.toFixed(1);
            splitResultsDisplayDiv.classList.remove('hidden');
            splitWeightResults.w1 = new Vector(mass1, thetaA_deg); splitWeightResults.w2 = new Vector(mass2, thetaB_deg);
            drawPolarPlotBasedOnMode(); 
        });


        function drawPolarPlotBasedOnMode() {
            const currentModeTab = document.querySelector('.tab-button.active').id;
            const currentLocation = measurementLocationSelect.value;
            const data = balancingData[currentLocation];
            let O_vec = null, OT_vec = null, T_eff_vec = null, Wc_vec_plot = null, Minus_O_vec_plot = null, Ws1_vec = null, Ws2_vec = null;

            if (data.originalAmp !== null && data.originalAngle !== null) { O_vec = new Vector(data.originalAmp, data.originalAngle); } 
            else if (data.lastOriginalForPlot) { O_vec = data.lastOriginalForPlot; }
            // Ensure vector instance
            if (O_vec && !(O_vec instanceof Vector) && O_vec.magnitude !== undefined) { O_vec = new Vector(O_vec.magnitude, O_vec.angleDeg); }
            if (data.correctionMass !== null && data.correctionAngle !== null && isFinite(data.correctionMass)) { Wc_vec_plot = new Vector(data.correctionMass, data.correctionAngle); }

            // Determine which vectors are active based on tab
            if (currentModeTab === 'tabStandard') {
                if (O_vec && data.trialRunAmp !== null && data.trialRunAngle !== null) {
                        OT_vec = new Vector(data.trialRunAmp, data.trialRunAngle);
                        T_eff_vec = OT_vec.subtract(O_vec);
                }
                if (Wc_vec_plot) {
                    const correctionStrategy = document.querySelector('input[name="correctionStrategy"]:checked').value;
                        if(correctionStrategy === 'keep' && OT_vec){ Minus_O_vec_plot = OT_vec.negate(); } 
                        else if (O_vec) { Minus_O_vec_plot = O_vec.negate(); }
                }
            } else if (currentModeTab === 'tabKnownIC' || currentModeTab === 'tabTrim') {
                    if (O_vec && Wc_vec_plot) { Minus_O_vec_plot = O_vec.negate(); }
            } else if (currentModeTab === 'tabSplitting') {
                const wcMassToSplit = parseFloat(splitWcMassInput.value), wcAngleToSplit = parseFloat(splitWcAngleInput.value);
                if (!isNaN(wcMassToSplit) && !isNaN(wcAngleToSplit) && wcMassToSplit > 0) { Wc_vec_plot = new Vector(wcMassToSplit, wcAngleToSplit); }
                if (splitWeightResults.w1 && splitWeightResults.w1.magnitude > 1e-9) Ws1_vec = splitWeightResults.w1;
                if (splitWeightResults.w2 && splitWeightResults.w2.magnitude > 1e-9) Ws2_vec = splitWeightResults.w2;
            }
            
            drawPolarPlot(O_vec, OT_vec, T_eff_vec, Wc_vec_plot, Minus_O_vec_plot, Ws1_vec, Ws2_vec);
        }
        
        // --- UPDATED: Draw Polar Plot Function (Clean + Interactive) ---
        function drawPolarPlot(O_vec, OT_vec, T_eff_vec, Wc_vec_plot, Minus_O_vec_plot, Ws1_vec, Ws2_vec) {
            vectorHitBoxes = []; // Reset hitboxes
            const numVanesPlot = parseInt(numVanesInput.value) || 12;
            const rotationDir = rotationDirectionInput.value; 
            const isDarkMode = document.documentElement.classList.contains('dark');

            // Colors
            const gridColor = isDarkMode ? "#4B5563" : "#D1D5DB"; 
            const labelColor = isDarkMode ? "#D1D5DB" : "#374151"; 
            const vaneLabelColor = isDarkMode ? "#9CA3AF" : "#6B7280"; 
            const bgColor = isDarkMode ? "#1F2937" : "#ffffff"; 
            const colorWc = isDarkMode ? "#FDBA74" : "orange"; 
            const colorWs1 = isDarkMode ? "#FDE047" : "#FFC107"; 
            const colorWs2 = isDarkMode ? "#A8A29E" : "#795548"; 
            const hsColor = isDarkMode ? "#F87171" : "red";
            const heavySColor = isDarkMode ? "#93C5FD" : "darkblue";

            // 1. Setup Canvas - FORCE SQUARE ASPECT RATIO
            const containerWidth = document.getElementById('polarPlotContainer').clientWidth;
            canvas.width = containerWidth;
            canvas.height = containerWidth; 
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const plotRadius = Math.min(centerX, centerY) * 0.75; 

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Scaling Logic
            let scaleDeterminingAmplitude = 1.0; 
            const vibrationAmps = [];
            if (O_vec && O_vec.magnitude > 1e-9) vibrationAmps.push(O_vec.magnitude);
            if (OT_vec && OT_vec.magnitude > 1e-9) vibrationAmps.push(OT_vec.magnitude);
            if (T_eff_vec && T_eff_vec.magnitude > 1e-9) vibrationAmps.push(T_eff_vec.magnitude);
            if (vibrationAmps.length > 0) { scaleDeterminingAmplitude = Math.max(...vibrationAmps); }
            if (scaleDeterminingAmplitude < 0.1) scaleDeterminingAmplitude = 1.0;

            const scale = plotRadius / scaleDeterminingAmplitude;

            // 3. Draw Grid (Circles)
            ctx.strokeStyle = gridColor;
            ctx.fillStyle = labelColor;
            ctx.font = "10px Arial";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            const numCircles = 4;
            for (let i = 1; i <= numCircles; i++) {
                const r = (plotRadius / numCircles) * i;
                ctx.beginPath(); ctx.arc(centerX, centerY, r, 0, 2 * Math.PI); ctx.stroke();
                const val = (scaleDeterminingAmplitude / numCircles) * i;
                const labelX = centerX + r * 0.707; 
                const labelY = centerY - r * 0.707; 
                ctx.clearRect(labelX - 10, labelY - 6, 20, 12); 
                ctx.fillText(val.toFixed(1), labelX, labelY);
            }

            // 4. Draw Vanes/Angles
            const angleStep = 360 / numVanesPlot;
            for (let i = 0; i < numVanesPlot; i++) {
                const rad = toRadians(i * angleStep);
                const xEnd = centerX + plotRadius * Math.cos(rad);
                const yEnd = centerY - plotRadius * Math.sin(rad);
                ctx.globalAlpha = 0.3; 
                ctx.beginPath(); ctx.moveTo(centerX, centerY); ctx.lineTo(xEnd, yEnd); ctx.stroke();
                ctx.globalAlpha = 1.0;
                
                let vaneLabel = (rotationDir === "CW") ? i : ((i === 0) ? 0 : (numVanesPlot - i));
                const lx = centerX + (plotRadius + 15) * Math.cos(rad);
                const ly = centerY - (plotRadius + 15) * Math.sin(rad);
                ctx.fillStyle = vaneLabelColor;
                ctx.font = "11px Arial";
                ctx.fillText(vaneLabel, lx, ly);
            }
            
            // 5. Draw Vectors
            let o_endX, o_endY; 
            if (O_vec && O_vec.magnitude > 1e-9) {
                const res = drawSingleVector(ctx, O_vec, isDarkMode ? "#60A5FA" : "blue", "Original (O)", centerX, centerY, scale, canvas.width);
                o_endX = res.endX; o_endY = res.endY;
            }
            if (OT_vec && OT_vec.magnitude > 1e-9) { 
                drawSingleVector(ctx, OT_vec, isDarkMode ? "#F87171" : "red", "Trial (O+T)", centerX, centerY, scale, canvas.width); 
            } 
            if (T_eff_vec && T_eff_vec.magnitude > 1e-9) {
                drawSingleVector(ctx, T_eff_vec, isDarkMode ? "#4ADE80" : "green", "Effective (T_eff)", centerX, centerY, scale, canvas.width, o_endX, o_endY); 
            }
            if (Minus_O_vec_plot && Minus_O_vec_plot.magnitude > 1e-9) { 
                const label = correctionWeightLabel.textContent.includes("Additional") ? 'Target -(O+T)' : 'Target -O';
                drawSingleVector(ctx, Minus_O_vec_plot, isDarkMode ? "#C084FC" : "purple", label, centerX, centerY, scale, canvas.width); 
            }
            
            const wcLabel = (document.querySelector('input[name="correctionStrategy"]:checked')?.value === 'keep') ? "Wc (Add)" : "Correction (Wc)";
            if (Wc_vec_plot && Wc_vec_plot.magnitude > 1e-9) {
                let drawVec = Wc_vec_plot;
                if(drawVec.magnitude > scaleDeterminingAmplitude) {
                    drawVec = new Vector(scaleDeterminingAmplitude, Wc_vec_plot.angleDeg); 
                }
                drawSingleVector(ctx, drawVec, colorWc, wcLabel, centerX, centerY, scale, canvas.width, undefined, undefined, null, Wc_vec_plot); 
            }

            if (Ws1_vec && Ws1_vec.magnitude > 1e-9) drawSingleVector(ctx, Ws1_vec, colorWs1, "Split W1", centerX, centerY, scale, canvas.width);
            if (Ws2_vec && Ws2_vec.magnitude > 1e-9) drawSingleVector(ctx, Ws2_vec, colorWs2, "Split W2", centerX, centerY, scale, canvas.width);

            // 6. Spots (High Spot / Heavy Spot) - With Value Capture
            
            // Initialize Legend Text Variables
            let highSpotLegendVal = '---';
            let heavySpotLegendVal = '---';

            if (O_vec && O_vec.magnitude > 1e-9) {
                // --- High Spot Logic ---
                let hsAngle = O_vec.angleDeg;
                if (rotationDir === "CCW" && hsAngle !== 0) hsAngle = normalizeAngle(360 - hsAngle);
                
                const hsRad = toRadians(hsAngle);
                const hsX = centerX + plotRadius * Math.cos(hsRad);
                const hsY = centerY - plotRadius * Math.sin(hsRad);
                
                ctx.beginPath(); ctx.arc(hsX, hsY, 5, 0, 2*Math.PI); ctx.fillStyle = hsColor; ctx.fill();
                
                // Set Legend Value (Using the raw angle, consistent with tooltip)
                highSpotLegendVal = `${O_vec.angleDeg.toFixed(1)}°`;
                
                vectorHitBoxes.push({type:'point', x:hsX, y:hsY, r:8, label:'High Spot (HS)', val: highSpotLegendVal});

                // --- Heavy Spot Logic ---
                const currentLocData = balancingData[measurementLocationSelect.value];
                let lagAngle = null;
                if (currentLocData.calculatedICAngle !== null) lagAngle = currentLocData.calculatedICAngle;
                else if (currentLocData.knownICAngle !== null) lagAngle = currentLocData.knownICAngle;

                if (lagAngle !== null) {
                     let hSAngle = normalizeAngle(O_vec.angleDeg - lagAngle);
                     let hSDisplay = hSAngle;
                     
                     // Adjust for Visual Plotting
                     if (rotationDir === "CCW" && hSDisplay !== 0) hSDisplay = normalizeAngle(360 - hSDisplay);
                     
                     const hSRad = toRadians(hSDisplay);
                     const hSX = centerX + plotRadius * Math.cos(hSRad);
                     const hSY = centerY - plotRadius * Math.sin(hSRad);
                     
                     ctx.beginPath(); ctx.arc(hSX, hSY, 5, 0, 2*Math.PI); ctx.fillStyle = heavySColor; ctx.fill();
                     
                     // Set Legend Value (Using the math angle, consistent with tooltip)
                     heavySpotLegendVal = `${hSAngle.toFixed(1)}°`;
                     
                     vectorHitBoxes.push({type:'point', x:hSX, y:hSY, r:8, label:'Heavy Spot (hS)', val: heavySpotLegendVal});
                }
            }

            // 7. GENERATE DETAILED LEGEND (UPDATED with Values)
            const fmt = (vec) => vec && vec.magnitude > 1e-9 ? `${vec.magnitude.toFixed(2)} @ ${vec.angleDeg.toFixed(1)}°` : '---';
            
            plotLegendDiv.innerHTML = `
                <div class="col-span-1 ${isDarkMode?'text-blue-400':'text-blue-600'}">
                    <span class="legend-color-box" style="background-color:${isDarkMode?'#60A5FA':'blue'}"></span> 
                    Orig (O): <span class="legend-value text-gray-800 dark:text-gray-200 font-bold">${fmt(O_vec)}</span>
                </div>
                <div class="col-span-1 ${isDarkMode?'text-red-400':'text-red-600'}">
                    <span class="legend-color-box" style="background-color:${isDarkMode?'#F87171':'red'}"></span> 
                    Trial (O+T): <span class="legend-value text-gray-800 dark:text-gray-200 font-bold">${fmt(OT_vec)}</span>
                </div>
                <div class="col-span-1 ${isDarkMode?'text-green-400':'text-green-600'}">
                    <span class="legend-color-box" style="background-color:${isDarkMode?'#4ADE80':'green'}"></span> 
                    Eff (T_eff): <span class="legend-value text-gray-800 dark:text-gray-200 font-bold">${fmt(T_eff_vec)}</span>
                </div>
                <div class="col-span-1 ${isDarkMode?'text-orange-300':'text-orange-500'}">
                    <span class="legend-color-box" style="background-color:${colorWc}"></span> 
                    Corr (Wc): <span class="legend-value text-gray-800 dark:text-gray-200 font-bold">${fmt(Wc_vec_plot)}</span>
                </div>
                <div class="col-span-1 ${isDarkMode?'text-purple-400':'text-purple-600'}">
                    <span class="legend-color-box" style="background-color:${isDarkMode?'#C084FC':'purple'}"></span> 
                    Target: <span class="legend-value text-gray-800 dark:text-gray-200 font-bold">${fmt(Minus_O_vec_plot)}</span>
                </div>
                
                <div class="col-span-1 ${isDarkMode?'text-red-400':'text-red-600'}">
                     <span class="legend-dot" style="background-color:${hsColor}"></span> 
                     High Spot (HS): <span class="legend-value text-gray-800 dark:text-gray-200 font-bold">${highSpotLegendVal}</span>
                </div>
                <div class="col-span-1 ${isDarkMode?'text-blue-300':'text-blue-900'}">
                     <span class="legend-dot" style="background-color:${heavySColor}"></span> 
                     Heavy Spot (hS): <span class="legend-value text-gray-800 dark:text-gray-200 font-bold">${heavySpotLegendVal}</span>
                </div>
            `;
            
            if(Ws1_vec || Ws2_vec) {
                 plotLegendDiv.innerHTML += `
                    <div class="col-span-1 ${isDarkMode?'text-yellow-300':'text-yellow-500'}">
                        <span class="legend-color-box" style="background-color:${colorWs1}"></span> Split 1: <span class="legend-value text-xs">${fmt(Ws1_vec)}</span>
                    </div>
                     <div class="col-span-1 ${isDarkMode?'text-stone-400':'text-stone-600'}">
                        <span class="legend-color-box" style="background-color:${colorWs2}"></span> Split 2: <span class="legend-value text-xs">${fmt(Ws2_vec)}</span>
                    </div>
                 `;
            }
        }
        
        // --- UPDATED: Draw Single Vector (Adds hitboxes, removes text) ---
        function drawSingleVector(ctx, vector, color, label, plotCenterX, plotCenterY, scaleFactor, canvasWidth, customStartX, customStartY, overrideLabel, trueVectorForData) {
            if (!vector || vector.magnitude < 1e-9) return {endX: plotCenterX, endY: plotCenterY};
            
            let plotAngleRad = vector.angleRad; 
            const currentRotationDir = rotationDirectionInput.value;
            // Rotation Adjustment for Display
            if (currentRotationDir === "CCW") { plotAngleRad = (vector.angleDeg !== 0) ? toRadians(normalizeAngle(360 - vector.angleDeg)) : 0; }
            
            const startX = (customStartX !== undefined && customStartX !== null) ? customStartX : plotCenterX;
            const startY = (customStartY !== undefined && customStartY !== null) ? customStartY : plotCenterY;
            
            const vectorPlotXComponent = vector.magnitude * Math.cos(plotAngleRad) * scaleFactor;
            const vectorPlotYComponent = vector.magnitude * Math.sin(plotAngleRad) * scaleFactor;
            
            const endX = startX + vectorPlotXComponent; 
            const endY = startY - vectorPlotYComponent; 
            
            // Draw Line
            ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY);
            ctx.strokeStyle = color; 
            ctx.lineWidth = 3; 
            ctx.stroke();
            
            // Draw Arrow Head
            const headLength = 12;
            const arrowAngle = Math.atan2(endY - startY, endX - startX);
            ctx.fillStyle = color; ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - headLength * Math.cos(arrowAngle - Math.PI / 6), endY - headLength * Math.sin(arrowAngle - Math.PI / 6));
            ctx.lineTo(endX - headLength * Math.cos(arrowAngle + Math.PI / 6), endY - headLength * Math.sin(arrowAngle + Math.PI / 6));
            ctx.closePath(); ctx.fill();

            // ** NEW: Store Hitbox data for hover interaction **
            const dataVec = trueVectorForData || vector;
            vectorHitBoxes.push({
                type: 'vector',
                startX: startX, startY: startY, endX: endX, endY: endY,
                label: label,
                val: `${dataVec.magnitude.toFixed(2)} @ ${dataVec.angleDeg.toFixed(1)}°`
            });
            
            return {endX, endY};
        }

        // --- NEW: Interactive Canvas Logic ---
        function setupCanvasInteractivity() {
            const canvas = document.getElementById('polarPlotCanvas');
            const tooltip = document.getElementById('polarPlotTooltip');
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
                const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                let found = null;
                
                // Check points (High/Heavy spots)
                for (let item of vectorHitBoxes) {
                    if(item.type === 'point') {
                        const dist = Math.sqrt((mouseX - item.x)**2 + (mouseY - item.y)**2);
                        if (dist < item.r + 5) { found = item; break; }
                    }
                }
                
                // Check vectors (Distance to line segment)
                if (!found) {
                    for (let item of vectorHitBoxes) {
                        if(item.type === 'vector') {
                            // Math to find distance from point to line segment
                            const A = mouseX - item.startX;
                            const B = mouseY - item.startY;
                            const C = item.endX - item.startX;
                            const D = item.endY - item.startY;
                            const dot = A * C + B * D;
                            const len_sq = C * C + D * D;
                            let param = -1;
                            if (len_sq !== 0) param = dot / len_sq;
                            
                            let xx, yy;
                            if (param < 0) { xx = item.startX; yy = item.startY; }
                            else if (param > 1) { xx = item.endX; yy = item.endY; }
                            else { xx = item.startX + param * C; yy = item.startY + param * D; }
                            
                            const dist = Math.sqrt((mouseX - xx)**2 + (mouseY - yy)**2);
                            if (dist < 10) { found = item; break; } // 10px tolerance
                        }
                    }
                }
                
                if (found) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.pageX - rect.left + 10) + 'px';
                    tooltip.style.top = (e.pageY - rect.top + 10) + 'px';
                    // Fix tooltip position to be relative to container
                    const container = document.getElementById('polarPlotContainer');
                    const containerRect = container.getBoundingClientRect();
                    const relativeX = e.clientX - containerRect.left + 15;
                    const relativeY = e.clientY - containerRect.top + 15;
                    
                    tooltip.style.left = relativeX + 'px';
                    tooltip.style.top = relativeY + 'px';
                    
                    tooltip.innerHTML = `<strong>${found.label}</strong><br>${found.val}`;
                    canvas.style.cursor = 'pointer';
                } else {
                    tooltip.style.display = 'none';
                    canvas.style.cursor = 'default';
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }

        // *** NEW: Helper function to build the data tables for reports ***
        function buildReportDataTable() {
            let dataTableHtml = '';
            
            if (lastProcessedLocations.length === 0) {
                return '<p>No calculation data available.</p>';
            }

            const isStandardMode = lastCalculationMode.includes('Standard');
            const isTrim = lastCalculationMode.includes('Trim');

            // Build Header
            dataTableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>Int. Amp</th>
                            <th>Int. Phase</th>
            `;
            if (isStandardMode) {
                dataTableHtml += `
                            <th>Tri. Amp</th>
                            <th>Tri. Phase</th>
                            <th>IC Mag</th>
                            <th>IC Angle</th>
                `;
            } else {
                dataTableHtml += `
                            <th>Kn. IC Mag</th>
                            <th>Kn. IC Angle</th>
                `;
            }
            // *** NEW: Add Final Run headers ***
            dataTableHtml += `<th>Resi. Amp</th>
            <th>Resi. Phase</th>`;
            
            if (isTrim) {
                dataTableHtml += `<th>Post-Trim Amp</th><th>Post-Trim Phase</th>`;
            }
            
            dataTableHtml += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Build Body
            for (const loc of lastProcessedLocations) {
                const data = balancingData[loc];
                const o_amp = data.originalAmp !== null ? data.originalAmp.toFixed(3) : '---';
                const o_ang = data.originalAngle !== null ? data.originalAngle.toFixed(1) : '---';
                
                dataTableHtml += `
                    <tr>
                        <td><strong>${loc}</strong></td>
                        <td>${o_amp}</td>
                        <td>${o_ang}</td>
                `;

                if (isStandardMode) {
                    const ot_amp = data.trialRunAmp !== null ? data.trialRunAmp.toFixed(3) : '---';
                    const ot_ang = data.trialRunAngle !== null ? data.trialRunAngle.toFixed(1) : '---';
                    const ic_mag = data.calculatedICMag !== null ? data.calculatedICMag.toFixed(4) : '---';
                    const ic_ang = data.calculatedICAngle !== null ? data.calculatedICAngle.toFixed(1) : '---';
                    dataTableHtml += `
                        <td>${ot_amp}</td>
                        <td>${ot_ang}</td>
                        <td>${ic_mag}</td>
                        <td>${ic_ang}</td>
                    `;
                } else {
                    const ic_mag = data.knownICMag !== null ? data.knownICMag.toFixed(4) : '---';
                    const ic_ang = data.knownICAngle !== null ? data.knownICAngle.toFixed(1) : '---';
                    dataTableHtml += `
                        <td>${ic_mag}</td>
                        <td>${ic_ang}</td>
                    `;
                }
                
                // *** NEW: Add Final Run data ***
                const preTrimAmp = data.finalAmp !== null ? data.finalAmp.toFixed(3) : '---';
                const preTrimAng = data.finalAngle !== null ? data.finalAngle.toFixed(1) : '---';
                
                dataTableHtml += `
                        <td>${preTrimAmp}</td>
                        <td>${preTrimAng}</td>
                `;

                // Add Post-Trim columns if Trim mode is active
                if (isTrim) {
                    const postTrimAmp = data.trimFinalAmp !== null ? data.trimFinalAmp.toFixed(3) : '---';
                    const postTrimAng = data.trimFinalAngle !== null ? data.trimFinalAngle.toFixed(1) : '---';
                    
                    dataTableHtml += `
                        <td>${postTrimAmp}</td>
                        <td>${postTrimAng}</td>
                    `;
                }

                dataTableHtml += `</tr>`;
            }
            // 1. Calculate how many columns we have so we can span the entire width
            let totalCols = 3; // Location + Int. Amp + Int. Phase
            if (isStandardMode) {
                totalCols += 4; // Tri. Amp + Tri. Phase + IC Mag + IC Angle
            } else {
                totalCols += 2; // Kn. IC Mag + Kn. IC Angle
            }
            totalCols += 2; // Residual Amp + Residual Phase
            if (isTrim) {
                totalCols += 2; // Post-Trim Amp + Post-Trim Phase
            }

            // 2. Build the abbreviation text string based on active mode
            let abbrevParts = [];
            abbrevParts.push("<strong>Int.</strong> = Initial");
            
            if (isStandardMode) {
                abbrevParts.push("<strong>Tri.</strong> = Trial");
                abbrevParts.push("<strong>IC</strong> = Influence Coefficient");
            } else {
                abbrevParts.push("<strong>Kn. IC</strong> = Known Influence Coefficient");
            }
              abbrevParts.push("<strong>Resi.</strong> = Residual");
              
            const abbrevString = abbrevParts.join("; ");

            // 3. Append the footer row
            dataTableHtml += `
                <tr style="background-color: #f8f9fa; border-top: 2px solid #e5e7eb;">
                    <td colspan="${totalCols}" style="padding: 6px; font-size: 8pt; color: #666; font-style: italic;">
                        <span style="font-weight:600; color:#444;">Note:</span> ${abbrevString}
                    </td>
                </tr>
            `;
            
            dataTableHtml += '</tbody></table>';
            return dataTableHtml;
        }
        
        // --- Footer Button Actions & Data Management (Save, Load, Export, Print, Reset) ---
        
        printReportButton.addEventListener('click', () => { 
            const isDarkMode = false; // Force Light Mode
            
            // 1. Get All Data
            const eqName = getInputValue('equipmentName', 'N/A');
            const plant = getInputValue('plantName', 'N/A');
            const date = getInputValue('reportDate', 'N/A');
            const vanes = getInputValue('numVanes', 'N/A');
            const rotDir = rotationDirectionInput.value;
            const power = getInputValue('ratedPower', 'N/A');
            const rpm = getInputValue('rotorRPM', 'N/A');
            const rotorType = getInputValue('rotorTypeSelect', 'N/A');
            const logoUrl = "https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/cbmlogo.png";
            const assetId = getInputValue('assetId', 'N/A');
            const prevWt = getInputValue('previousWeight', 'N/A');
            const remarks = getInputValue('analystRemarks', 'None');
            
            const plotLocation = measurementLocationSelect.value;
            const data = balancingData[plotLocation];
            const hasStdResults = !resultsDisplayDiv.classList.contains('hidden');
            
            // --- NEW: Get Trial Weight Data ---
            const twMass = balancingData.trialWeight.mass !== null ? balancingData.trialWeight.mass.toFixed(2) : '---';
            const twAngle = balancingData.trialWeight.angle !== null ? balancingData.trialWeight.angle.toFixed(1) : '---';
            const isStandardMode = lastCalculationMode.includes('Standard');

            // Final Action Strings
            const addMass = (data.correctionMass !== null) ? data.correctionMass.toFixed(3) : '---';
            const addAngle = (data.correctionAngle !== null) ? data.correctionAngle.toFixed(1) : '---';
            const removeMass = (data.removalMass !== null) ? data.removalMass.toFixed(3) : '---';
            const removeAngle = (data.removalAngle !== null) ? data.removalAngle.toFixed(1) : '---';
            
            // --- UPDATED ACTION TAKEN LOGIC (Fixing Issue 1) ---
            let finalActionHTML = '';
            const isTrim = lastCalculationMode.includes('Trim');
            const isMerged = data.isTrimMerged === true;

            // Scenario A: Trim Mode WITHOUT Merge -> Show Both Weights
            if (isTrim && !isMerged && data.initialCorrectionMass !== null && data.trimCorrectionMass !== null) {
                const initM = data.initialCorrectionMass.toFixed(3);
                const initA = data.initialCorrectionAngle.toFixed(1);
                const trimM = data.trimCorrectionMass.toFixed(3);
                const trimA = data.trimCorrectionAngle.toFixed(1);
                
                finalActionHTML = `<p><strong>Action Taken:</strong> Weight Addition 1 (${initM} g @ ${initA}&deg;) AND Weight Addition 2 (${trimM} g @ ${trimA}&deg;)</p>`;
            } 
            // Scenario B: Standard or Merged Trim -> Show Final Result
            else {
                if (lastBalancingAction === 'add') {
                    finalActionHTML = `<p><strong>Action Taken:</strong> Weight Addition (${addMass} g @ ${addAngle}&deg;)</p>`;
                } else {
                    finalActionHTML = `<p><strong>Action Taken:</strong> Weight Removal (${removeMass} g @ ${removeAngle}&deg;)</p>`;
                }
            }

            // --- UPDATED SUMMARY LOGIC (Fixing Issue 2) ---
            let summaryHtml = `<p><strong>Mode:</strong> ${lastCalculationMode}</p>`;

            // 1. Trial Weight
            if (lastCalculationMode.includes('Standard')) {
                summaryHtml += `<p><strong>Trial Weight:</strong> ${twMass} g @ ${twAngle}&deg;</p>`;
            }

            // 2. Initial Correction Weight
            if (data.initialCorrectionMass !== null && data.initialCorrectionMass !== undefined) {
                 summaryHtml += `<p><strong>Initial Correction Weight:</strong> ${data.initialCorrectionMass.toFixed(3)} g @ ${data.initialCorrectionAngle.toFixed(1)}&deg;</p>`;
            }

            // 3. Trim Correction Weight
            if (isTrim && data.trimCorrectionMass !== null && data.trimCorrectionMass !== undefined) {
                let mergeText = isMerged ? " (Merge with previous)" : "";
                summaryHtml += `<p><strong>Trim Correction Weight:</strong> ${data.trimCorrectionMass.toFixed(3)} g @ ${data.trimCorrectionAngle.toFixed(1)}&deg;${mergeText}</p>`;
            }
            
            const dataTableHtml = buildReportDataTable();
            const plotImage = canvas.toDataURL('image/png');
            
            // Legend Construction
            const fmt = (mag, ang) => (mag !== null && ang !== null) ? `${mag.toFixed(2)} @ ${ang.toFixed(1)}&deg;` : '---';
            
            let hsText = '---';
            let heavyText = '---';
            if (data.originalAngle !== null) {
                hsText = `${data.originalAngle.toFixed(1)}&deg;`;
                let icAng = (data.calculatedICAngle !== null) ? data.calculatedICAngle : data.knownICAngle;
                if (icAng !== null) {
                    let heavyVal = normalizeAngle(data.originalAngle - icAng);
                    heavyText = `${heavyVal.toFixed(1)}&deg;`;
                }
            }

            const legendHtml = `
                <div class="legend-grid">
                    <div style="color: blue;"><strong><span style="display:inline-block;width:10px;height:10px;background:blue;margin-right:5px;"></span>Original:</strong> ${fmt(data.originalAmp, data.originalAngle)}</div>
                    <div style="color: red;"><strong><span style="display:inline-block;width:10px;height:10px;background:red;margin-right:5px;"></span>Trial:</strong> ${fmt(data.trialRunAmp, data.trialRunAngle)}</div>
                    <div style="color: orange;"><strong><span style="display:inline-block;width:10px;height:10px;background:orange;margin-right:5px;"></span>Corr (Wc):</strong> ${fmt(data.correctionMass, data.correctionAngle)}</div>
                    <div style="color: #F87171;"><strong><span style="display:inline-block;width:8px;height:8px;background:#F87171;border-radius:50%;margin-right:5px;"></span>High Spot:</strong> ${hsText}</div>
                    <div style="color: darkblue;"><strong><span style="display:inline-block;width:8px;height:8px;background:darkblue;border-radius:50%;margin-right:5px;"></span>Heavy Spot:</strong> ${heavyText}</div>
                </div>
            `;

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <title>Balancing Report - ${eqName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; font-size: 10pt; color: #000; }
                        @page { size: A4; margin: 15mm; }
                        .container { width: 100%; max-width: 180mm; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #003366; padding-bottom: 5px; margin-bottom: 10px; }
                        .header img { height: 40px; }
                        .header h1 { font-size: 16pt; color: #003366; margin: 0; }
                        h2 { font-size: 12pt; color: #003366; border-bottom: 1px solid #ccc; padding-bottom: 2px; margin-top: 15px; margin-bottom: 5px; }
                        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 10px; }
                        .details-grid p { margin: 2px 0; }
                        .data-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt; }
                        .data-table th, .data-table td { border: 1px solid #ddd; padding: 4px; text-align: left; }
                        .data-table th { background-color: #f2f2f2; }
                        .results-group { margin-top: 10px; padding: 8px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; }
                        .results-group p { margin: 3px 0; }
                        .plot-container { text-align: center; margin-top: 15px; page-break-inside: avoid; }
                        .plot-container img { max-width: 45%; max-height: 300px; width: auto; height: auto; border: 1px solid #ccc; }
                        .legend-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; font-size: 8pt; text-align: left; padding: 5px; border: 1px solid #eee; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <img src="${logoUrl}" alt="Logo">
                            <h1>Dynamic Balancing Report</h1>
                        </div>
                        
                        <h2>Job Details</h2>
                        <div class="details-grid">
                            <p><strong><i class="fas fa-fan"></i> Equipment:</strong> ${eqName}</p>
                            <p><strong><i class="fas fa-industry"></i> Plant:</strong> ${plant}</p>
                            <p><strong><i class="fas fa-fingerprint"></i> Asset ID:</strong> ${assetId}</p>
                            <p><strong><i class="far fa-calendar-alt"></i> Date:</strong> ${date}</p>
                            <p><strong><i class="fas fa-tachometer-alt"></i> Rotor RPM:</strong> ${rpm}</p>
                            <p><strong><i class="fas fa-bolt"></i> Rated Power:</strong> ${power}</p>
                            <p><strong><i class="fas fa-certificate"></i> Number of Vanes:</strong> ${vanes}</p>
                            <p><strong><i class="fas fa-shapes"></i> Rotor Type:</strong> ${rotorType}</p>
                            <p><strong><i class="fas fa-sync-alt mr-2"></i> Rotation:</strong> ${rotDir}</p>
                            <p><strong><i class="fas fa-history"></i> Prev. Weight:</strong> ${prevWt}</p>
                        </div>

                        <h2>Data Used</h2>
                        ${dataTableHtml}
                        
                        ${(hasStdResults || lastCalculationMode.includes('Trim')) ? `
                        <h2>Summary</h2>
                        <div class="results-group">
                            ${summaryHtml}      ${finalActionHTML}
                        </div>
                        ` : ''}

                        <h2>Polar Plot (${plotLocation})</h2>
                        <div class="plot-container">
                            <img src="${plotImage}" alt="Polar Plot">
                            ${legendHtml}
                        </div>
                        <h2>Observations & Remarks</h2>
                    <div class="results-group" style="min-height: 40px; white-space: pre-wrap;">
                        ${remarks}
                    </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHtml);
            printWindow.document.close();
            printWindow.onload = function() { setTimeout(() => { printWindow.print(); }, 500); };
        });

        exportWordButton.addEventListener('click', () => { 
            const isDarkMode = false;

            // 1. Get All Data
            const eqName = getInputValue('equipmentName', 'N/A');
            const plant = getInputValue('plantName', 'N/A');
            const date = getInputValue('reportDate', 'N/A');
            const vanes = getInputValue('numVanes', 'N/A');
            const rotDir = rotationDirectionInput.value;
            const power = getInputValue('ratedPower', 'N/A');
            const rpm = getInputValue('rotorRPM', 'N/A');
            const rotorType = getInputValue('rotorTypeSelect', 'N/A');
            
            const plotLocation = measurementLocationSelect.value;
            const data = balancingData[plotLocation];
            const hasStdResults = !resultsDisplayDiv.classList.contains('hidden') || lastCalculationMode.includes('Trim');
            
            // --- NEW: Trial Weight Data ---
            const twMass = balancingData.trialWeight.mass !== null ? balancingData.trialWeight.mass.toFixed(2) : '---';
            const twAngle = balancingData.trialWeight.angle !== null ? balancingData.trialWeight.angle.toFixed(1) : '---';
            const isStandardMode = lastCalculationMode.includes('Standard');

            // Formatters
            const fmt = (mag, ang) => (mag !== null && ang !== null) ? `${mag.toFixed(2)} @ ${ang.toFixed(1)}` : '---';
            
            let hsText = '---';
            let heavyText = '---';
            if (data.originalAngle !== null) {
                hsText = `${data.originalAngle.toFixed(1)}`;
                let icAng = (data.calculatedICAngle !== null) ? data.calculatedICAngle : data.knownICAngle;
                if (icAng !== null) {
                    heavyText = `${normalizeAngle(data.originalAngle - icAng).toFixed(1)}`;
                }
            }

            const dataTableHtml = buildReportDataTable();
            const plotImage = canvas.toDataURL('image/png');

            // Legend Table
            const legendTable = `
                <table style="width:100%; font-size:9pt; margin-top:5px; border:1px solid #ddd;">
                    <tr>
                        <td style="color:blue;"><strong>Original:</strong> ${fmt(data.originalAmp, data.originalAngle)}</td>
                        <td style="color:red;"><strong>Trial:</strong> ${fmt(data.trialRunAmp, data.trialRunAngle)}</td>
                        <td style="color:orange;"><strong>Corr (Wc):</strong> ${fmt(data.correctionMass, data.correctionAngle)}</td>
                    </tr>
                    <tr>
                        <td style="color:#D32F2F;"><strong>High Spot:</strong> ${hsText}&deg;</td>
                        <td style="color:darkblue;"><strong>Heavy Spot:</strong> ${heavyText}&deg;</td>
                        <td></td>
                    </tr>
                </table>
            `;
            
            // Final Action HTML for Word
            let finalActionString = "";
            if (lastBalancingAction === 'add') {
                const addMass = (data.correctionMass !== null) ? data.correctionMass.toFixed(3) : '---';
                const addAngle = (data.correctionAngle !== null) ? data.correctionAngle.toFixed(1) : '---';
                finalActionString = `<p><strong>Action Taken:</strong> Weight Addition (${addMass} g @ ${addAngle}&deg;)</p>`;
            } else {
                const removeMass = (data.removalMass !== null) ? data.removalMass.toFixed(3) : '---';
                const removeAngle = (data.removalAngle !== null) ? data.removalAngle.toFixed(1) : '---';
                finalActionString = `<p><strong>Action Taken:</strong> Weight Removal (${removeMass} g @ ${removeAngle}&deg;)</p>`;
            }

            const preHtml = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta charset="utf-8"><title>Report</title>
                <style>
                    body { font-family: Arial; font-size: 10pt; }
                    h1 { color: #003366; font-size: 16pt; margin-bottom: 10px; }
                    h2 { color: #003366; font-size: 12pt; border-bottom: 1px solid #ccc; margin-top: 15px; margin-bottom: 5px; }
                    table { border-collapse: collapse; width: 100%; }
                    td, th { padding: 4px; text-align: left; }
                    .data-table td, .data-table th { border: 1px solid #999; }
                </style>
                </head><body>
            `;
            
            const contentHtml = `
                <div class="container">
                    <h1>Dynamic Balancing Report</h1>
                    
                    <h2>Job Details</h2>
                    <table style="border: none;">
                        <tr>
                            <td width="50%"><strong>Equipment:</strong> ${eqName}</td>
                            <td width="50%"><strong>Plant:</strong> ${plant}</td>
                        </tr>
                        <tr>
                            <td><strong>Date:</strong> ${date}</td>
                            <td><strong>RPM:</strong> ${rpm}</td>
                        </tr>
                        <tr>
                            <td><strong>Rated Power:</strong> ${power}</td>
                            <td><strong>Vanes:</strong> ${vanes}</td>
                        </tr>
                        <tr>
                            <td><strong>Rotation:</strong> ${rotDir}</td>
                            <td><strong>Rotor Type:</strong> ${rotorType}</td>
                        </tr>
                    </table>

                    <h2>Data Used</h2>
                    <div class="data-table">
                        ${dataTableHtml}
                    </div>
                    
                    ${hasStdResults ? `
                    <h2>Summary</h2>
                    <p><strong>Mode:</strong> ${lastCalculationMode}</p>
                    ${isStandardMode ? `<p><strong>Trial Weight:</strong> ${twMass} g @ ${twAngle}&deg;</p>` : ''}
                    ${finalActionString}
                    ` : ''}

                    <h2>Polar Plot (${plotLocation})</h2>
                    <div style="text-align:center;">
                        <img src="${plotImage}" width="400" height="400" alt="Plot">
                        ${legendTable}
                    </div>
                </div>
            `;
            
            const fullHtml = preHtml + contentHtml + "</body></html>";

            const blob = new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Report_${eqName}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        saveDataButton.addEventListener('click', () => { 
             const allData = {
                header: {
                    equipmentName: equipmentNameInput.value,
                    plantName: plantNameInput.value,
                    reportDate: reportDateInput.value
                },
                details: {
                    numVanes: numVanesInput.value,
                    rotationDirection: rotationDirectionInput.value,
                    ratedPower: ratedPowerInput.value,
                    rotorRPM: rotorRPMInput.value,
                    rotorType: rotorTypeSelect.value,
                },
                suggestion: {
                    rotorWeight: rotorWeightInput.value,
                    trialRadius: trialRadiusInput.value
                },
                // *** FIX: Save the critical global variables for reporting ***
                globalState: {
                    lastCalculationMode: lastCalculationMode,
                    lastProcessedLocations: lastProcessedLocations,
                    lastBalancingAction: lastBalancingAction,
                    measurementLocation: measurementLocationSelect.value
                },
                balancingData: balancingData // Save the whole object
             };
             
             const dataStr = JSON.stringify(allData, null, 2);
             const dataBlob = new Blob([dataStr], {type: 'application/json'});
             const url = URL.createObjectURL(dataBlob);
             const link = document.createElement('a');
             const cleanName = (equipmentNameInput.value || 'export').replace(/[^a-z0-9]/gi, '_');
             link.download = `balancing_data_${cleanName}_${reportDateInput.value}.json`;
             link.href = url;
             link.click();
             URL.revokeObjectURL(url);
             console.log("Data saved.");
        });
        
        loadDataButton.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    try {
                        const content = readerEvent.target.result;
                        const loadedData = JSON.parse(content);
                        // Use the helper function here
                        loadDataFromObject(loadedData); 
                    } catch (err) {
                        console.error("Failed to load or parse file:", err);
                        displayError("Failed to load file. It may be corrupted or not a valid JSON export.");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        });
        resetFormButton.addEventListener('click', () => {
             if (confirm("Are you sure you want to reset all fields? All unsaved data will be lost.")) {
                 resetAllFields();
             }
        });

        function setupTableCheckboxLogic() {
            const stdHeaderCB = document.getElementById('selectAllStandard');
            const kicHeaderCB = document.getElementById('selectAllKnownIC');
            const trimHeaderCB = document.getElementById('selectAllTrim');

            if (stdHeaderCB) {
                stdHeaderCB.addEventListener('change', () => {
                    const checkboxes = standardBalancingTableBody.querySelectorAll('.loc-checkbox-standard');
                    checkboxes.forEach(cb => cb.checked = stdHeaderCB.checked);
                });
            }
            
            if (kicHeaderCB) {
                kicHeaderCB.addEventListener('change', () => {
                    const checkboxes = knownIcTableBody.querySelectorAll('.loc-checkbox-knownic');
                    checkboxes.forEach(cb => cb.checked = kicHeaderCB.checked);
                });
            }
            
            if (trimHeaderCB) {
                trimHeaderCB.addEventListener('change', () => {
                    const checkboxes = trimBalancingTableBody.querySelectorAll('.loc-checkbox-trim');
                    checkboxes.forEach(cb => cb.checked = trimHeaderCB.checked);
                });
            }

            const updateHeaderState = (body, headerCheckbox, className) => {
                if (!headerCheckbox) return;
                const checkboxes = body.querySelectorAll(className);
                if (checkboxes.length === 0) return;
                
                const total = checkboxes.length;
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

                if (checkedCount === 0) {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = false;
                } else if (checkedCount === total) {
                    headerCheckbox.checked = true;
                    headerCheckbox.indeterminate = false;
                } else {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = true;
                }
            };

            standardBalancingTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('loc-checkbox-standard')) {
                    updateHeaderState(standardBalancingTableBody, stdHeaderCB, '.loc-checkbox-standard');
                }
            });

            knownIcTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('loc-checkbox-knownic')) {
                    updateHeaderState(knownIcTableBody, kicHeaderCB, '.loc-checkbox-knownic');
                }
            });
            
            trimBalancingTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('loc-checkbox-trim')) {
                    updateHeaderState(trimBalancingTableBody, trimHeaderCB, '.loc-checkbox-trim');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            initializeData(); 
            updateGlobalTrialWeightFields();
            setupTableCheckboxLogic(); 
            
            // ** NEW: Call setup for interactivity **
            setupCanvasInteractivity();

            document.getElementById('finalActionAdd').addEventListener('change', (e) => {
                if (e.target.checked) lastBalancingAction = 'add';
            });
            document.getElementById('finalActionRemove').addEventListener('change', (e) => {
                if (e.target.checked) lastBalancingAction = 'remove';
            });
            
            switchTab(document.querySelector('.tab-button.active'), document.querySelector('.tab-content:not(.hidden)'));
            
            plotLocationLabelSpan.textContent = measurementLocationSelect.value;
            currentLocSplittingSpan.textContent = measurementLocationSelect.value;

            drawPolarPlotBasedOnMode();
        });
        
        window.addEventListener('resize', () => {
             drawPolarPlotBasedOnMode();
        });

    </script>
</body>
</html>
